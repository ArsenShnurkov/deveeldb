<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb-nunit\deveel.data.sql.expressions\sqlqueryexpressiontests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2014 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.

using System;
using System.Linq;

using Deveel.Data.Configuration;
using Deveel.Data.DbSystem;
using Deveel.Data.Protocol;
using Deveel.Data.Security;
using Deveel.Data.Sql.Objects;
using Deveel.Data.Types;

using NUnit.Framework;

namespace Deveel.Data.Sql.Expressions {
	[TestFixture]
	public sealed class SqlQueryExpressionTests {
		private IUserSession session;

		[SetUp]
		public void SetUp() {
			var systemContext = new SystemContext(DbConfig.Default);
			var dbContext = new DatabaseContext(systemContext, &quot;testdb&quot;);
			var database = new Database(dbContext);
			database.Create(&quot;SA&quot;, &quot;12345&quot;);
			database.Open();

			session = database.CreateSession(User.System);
			CreateTestTable();
			AddTestData();
		}

		private void CreateTestTable() {
			var tableInfo = new TableInfo(ObjectName.Parse(&quot;APP.test_table&quot;));
			var idColumn = tableInfo.AddColumn(&quot;id&quot;, PrimitiveTypes.Integer());
			idColumn.DefaultExpression = SqlExpression.FunctionCall(&quot;UNIQUE_KEY&quot;,
				new SqlExpression[] {SqlExpression.Reference(tableInfo.TableName)});
			tableInfo.AddColumn(&quot;first_name&quot;, PrimitiveTypes.String());
			tableInfo.AddColumn(&quot;last_name&quot;, PrimitiveTypes.String());
			tableInfo.AddColumn(&quot;birth_date&quot;, PrimitiveTypes.Date());
			tableInfo.AddColumn(&quot;active&quot;, PrimitiveTypes.Boolean());

			session.CreateTable(tableInfo);
			session.AddPrimaryKey(tableInfo.TableName, &quot;id&quot;, &quot;PK_TEST_TABLE&quot;);
		}

		private void AddTestData() {
			var table = session.GetMutableTable(ObjectName.Parse(&quot;APP.test_table&quot;));
			var row = table.NewRow();
			row.SetValue(&quot;first_name&quot;, DataObject.String(&quot;John&quot;));
			row.SetValue(&quot;last_name&quot;, DataObject.String(&quot;Doe&quot;));
			row.SetValue(&quot;birth_date&quot;, DataObject.Date(new SqlDateTime(1977, 01, 01)));
			row.SetValue(&quot;active&quot;, DataObject.Boolean(false));
			table.AddRow(row);

			row = table.NewRow();
			row.SetValue(&quot;first_name&quot;, DataObject.String(&quot;Jane&quot;));
			row.SetValue(&quot;last_name&quot;, DataObject.String(&quot;Doe&quot;));
			row.SetValue(&quot;birth_date&quot;, DataObject.Date(new SqlDateTime(1978, 11, 01)));
			row.SetValue(&quot;active&quot;, DataObject.Boolean(true));
			table.AddRow(row);

			row = table.NewRow();
			row.SetValue(&quot;first_name&quot;, DataObject.String(&quot;Roger&quot;));
			row.SetValue(&quot;last_name&quot;, DataObject.String(&quot;Rabbit&quot;));
			row.SetValue(&quot;birth_date&quot;, DataObject.Date(new SqlDateTime(1985, 05, 05)));
			row.SetValue(&quot;active&quot;, DataObject.Boolean(true));
			table.AddRow(row);
		}

		[Test]
		[Category(&quot;System&quot;)]
		public void ExecuteSelectAll() {
			var expression =
				new SqlQueryExpression(new[] {new SelectColumn(SqlExpression.Reference(new ObjectName(&quot;first_name&quot;)))});
			expression.FromClause.AddTable(&quot;test_table&quot;);

			var queryContext = new SessionQueryContext(session);

			DataObject result = null;
			Assert.DoesNotThrow(() =&gt; result = expression.EvaluateToConstant(queryContext, null));
			Assert.IsNotNull(result);
			Assert.IsInstanceOf&lt;QueryType&gt;(result.Type);
			Assert.IsNotNull(result.Value);
			Assert.IsInstanceOf&lt;SqlQueryObject&gt;(result.Value);

			ITable queryResult = null;

			Assert.DoesNotThrow(() =&gt; queryResult = ((SqlQueryObject) result.Value).QueryPlan.Evaluate(queryContext));
			Assert.IsNotNull(queryResult);
			Assert.AreEqual(3, queryResult.RowCount);
		}

		[Test]
		[Category(&quot;SQL Parse&quot;)]
		public void ParseSelectWithFromClause() {
			const string sql = &quot;SELECT col1 AS a FROM table&quot;;

			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(sql));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			var queryExpression = (SqlQueryExpression) expression;
			Assert.IsNotEmpty(queryExpression.SelectColumns);
			Assert.IsInstanceOf&lt;SqlReferenceExpression&gt;(queryExpression.SelectColumns.First().Expression);
			Assert.AreEqual(&quot;a&quot;, queryExpression.SelectColumns.First().Alias);
			Assert.IsNotNull(queryExpression.FromClause);
			Assert.AreEqual(1, queryExpression.FromClause.AllTables.Count());
			Assert.AreEqual(&quot;table&quot;, queryExpression.FromClause.AllTables.First().Name);
		}

		[Test]
		[Category(&quot;SQL Parse&quot;)]
		public void ParseSelectWithNaturalJoin() {
			const string sql = &quot;SELECT a.col1, b.col2 FROM table1 a, table2 b&quot;;

			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(sql));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			var queryExpression = (SqlQueryExpression) expression;
			Assert.IsNotEmpty(queryExpression.SelectColumns);
			Assert.IsInstanceOf&lt;SqlReferenceExpression&gt;(queryExpression.SelectColumns.First().Expression);
			Assert.IsInstanceOf&lt;SqlReferenceExpression&gt;(queryExpression.SelectColumns.Skip(1).First().Expression);
			Assert.IsNotNull(queryExpression.FromClause);
			Assert.IsNotEmpty(queryExpression.FromClause.AllTables);
			Assert.AreEqual(2, queryExpression.FromClause.AllTables.Count());
			Assert.AreEqual(1, queryExpression.FromClause.JoinPartCount);
			Assert.IsNotNull(queryExpression.FromClause.GetJoinPart(0));
			Assert.AreEqual(JoinType.Inner, queryExpression.FromClause.GetJoinPart(0).JoinType);
		}

		[Test]
		[Category(&quot;SQL Parse&quot;)]
		public void ParseSelectWithInnerJoin() {
			const string sql = &quot;SELECT a.col1, b.col2 FROM table1 AS a INNER JOIN table2 b ON a.id = b.id&quot;;

			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(sql));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			var queryExpression = (SqlQueryExpression) expression;
			Assert.IsNotEmpty(queryExpression.SelectColumns);
			Assert.IsInstanceOf&lt;SqlReferenceExpression&gt;(queryExpression.SelectColumns.First().Expression);
			Assert.IsInstanceOf&lt;SqlReferenceExpression&gt;(queryExpression.SelectColumns.Skip(1).First().Expression);
			Assert.IsNotNull(queryExpression.FromClause);
			Assert.IsNotEmpty(queryExpression.FromClause.AllTables);
			Assert.AreEqual(2, queryExpression.FromClause.AllTables.Count());
			Assert.AreEqual(1, queryExpression.FromClause.JoinPartCount);
			Assert.IsNotNull(queryExpression.FromClause.GetJoinPart(0));
			Assert.AreEqual(JoinType.Inner, queryExpression.FromClause.GetJoinPart(0).JoinType);
			Assert.IsNotNull(queryExpression.FromClause.GetJoinPart(0).OnExpression);
			Assert.IsInstanceOf&lt;SqlBinaryExpression&gt;(queryExpression.FromClause.GetJoinPart(0).OnExpression);
		}

		[Test]
		[Category(&quot;SQL Parse&quot;)]
		public void ParseSelectFunction() {
			const string sql = &quot;SELECT user()&quot;;

			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(sql));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			var queryExpression = (SqlQueryExpression) expression;
			Assert.IsNotEmpty(queryExpression.SelectColumns);
			Assert.IsInstanceOf&lt;SqlFunctionCallExpression&gt;(queryExpression.SelectColumns.First().Expression);
			Assert.AreEqual(&quot;user&quot;, ((SqlFunctionCallExpression) queryExpression.SelectColumns.First().Expression).FunctioName.FullName);
		}

		[Test]
		[Category(&quot;SQL Parse&quot;)]
		public void ParseSelectSubQuery() {
			const string sql = &quot;SELECT * FROM (SELECT a, b FROM table1)&quot;;

			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(sql));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			var queryExpression = (SqlQueryExpression) expression;
			Assert.IsNotEmpty(queryExpression.SelectColumns);
			Assert.IsNotEmpty(queryExpression.FromClause.AllTables);
			Assert.AreEqual(1, queryExpression.FromClause.AllTables.Count());
			Assert.IsTrue(queryExpression.FromClause.AllTables.First().IsSubQuery);
		}

		//[Test]
		//public void FluidSelectWithClause() {
		//	var expression = SqlQueryBuilder.Configure().Items(list =&gt; list.Column(&quot;col1&quot;, &quot;a&quot;)).From(&quot;table&quot;).AsExpression();
		//}

		[Test]
		[Category(&quot;SQL Parse&quot;)]
		public void ParseSimpleQuery() {
			const string sql = &quot;SELECT col1 AS a FROM table&quot;;

			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(sql));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			var queryExpression = (SqlQueryExpression)expression;
			Assert.IsNotEmpty(queryExpression.SelectColumns);
			Assert.IsInstanceOf&lt;SqlReferenceExpression&gt;(queryExpression.SelectColumns.First().Expression);
			Assert.AreEqual(&quot;a&quot;, queryExpression.SelectColumns.First().Alias);
			Assert.IsNotNull(queryExpression.FromClause);
			Assert.AreEqual(1, queryExpression.FromClause.AllTables.Count());
			Assert.AreEqual(&quot;table&quot;, queryExpression.FromClause.AllTables.First().Name);
		}

		[Test]
		[Category(&quot;SQL Parse&quot;)]
		public void ParseSelectGroupBy() {
			const string sql = &quot;SELECT col1 AS a, AVG(col2) b FROM table WHERE b &gt; 2 GROUP BY a&quot;;

			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(sql));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			var queryExpression = (SqlQueryExpression)expression;
			Assert.IsNotEmpty(queryExpression.SelectColumns);

			var groupBy = queryExpression.GroupBy;
			Assert.IsNotNull(groupBy);
			Assert.IsNotEmpty(groupBy);
			Assert.AreEqual(1, groupBy.Count());
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[35,4,35,60,1],[36,4,36,65,1],[37,4,37,43,1],[38,4,38,35,1],[39,4,39,20,1],[41,4,41,50,1],[42,4,42,22,1],[43,4,43,18,1],[44,3,44,4,1],[47,4,47,70,1],[48,4,48,71,1],[49,4,50,73,1],[51,4,51,63,1],[52,4,52,62,1],[53,4,53,61,1],[54,4,54,60,1],[56,4,56,35,1],[57,4,57,70,1],[58,3,58,4,1],[61,4,61,76,1],[62,4,62,29,1],[63,4,63,58,1],[64,4,64,56,1],[65,4,65,79,1],[66,4,66,54,1],[67,4,67,22,1],[69,4,69,25,1],[70,4,70,58,1],[71,4,71,56,1],[72,4,72,79,1],[73,4,73,53,1],[74,4,74,22,1],[76,4,76,25,1],[77,4,77,59,1],[78,4,78,59,1],[79,4,79,79,1],[80,4,80,53,1],[81,4,81,22,1],[82,3,82,4,1],[87,4,88,109,1],[89,4,89,49,1],[91,4,91,56,1],[93,4,93,29,1],[94,4,94,30,1],[94,88,94,90,1],[95,4,95,29,1],[96,4,96,48,1],[97,4,97,35,1],[98,4,98,54,1],[100,4,100,30,1],[102,4,102,30,1],[102,108,102,110,1],[103,4,103,34,1],[104,4,104,45,1],[105,3,105,4,1],[112,4,112,36,1],[113,4,113,30,1],[113,67,113,69,1],[114,4,114,33,1],[115,4,115,56,1],[117,4,117,58,1],[118,4,118,53,1],[119,4,119,98,1],[120,4,120,70,1],[121,4,121,49,1],[122,4,122,69,1],[123,4,123,80,1],[124,3,124,4,1],[131,4,131,36,1],[132,4,132,30,1],[132,67,132,69,1],[133,4,133,33,1],[134,4,134,56,1],[136,4,136,58,1],[137,4,137,53,1],[138,4,138,98,1],[139,4,139,106,1],[140,4,140,49,1],[141,4,141,60,1],[142,4,142,69,1],[143,4,143,65,1],[144,4,144,64,1],[145,4,145,88,1],[146,3,146,4,1],[153,4,153,36,1],[154,4,154,30,1],[154,67,154,69,1],[155,4,155,33,1],[156,4,156,56,1],[158,4,158,58,1],[159,4,159,53,1],[160,4,160,98,1],[161,4,161,106,1],[162,4,162,49,1],[163,4,163,60,1],[164,4,164,69,1],[165,4,165,65,1],[166,4,166,64,1],[167,4,167,88,1],[168,4,168,77,1],[169,4,169,101,1],[170,3,170,4,1],[177,4,177,36,1],[178,4,178,30,1],[178,67,178,69,1],[179,4,179,33,1],[180,4,180,56,1],[182,4,182,58,1],[183,4,183,53,1],[184,4,184,101,1],[185,4,185,129,1],[186,3,186,4,1],[193,4,193,36,1],[194,4,194,30,1],[194,67,194,69,1],[195,4,195,33,1],[196,4,196,56,1],[198,4,198,58,1],[199,4,199,53,1],[200,4,200,60,1],[201,4,201,69,1],[202,4,202,75,1],[203,3,203,4,1],[215,4,215,36,1],[216,4,216,30,1],[216,67,216,69,1],[217,4,217,33,1],[218,4,218,56,1],[220,4,220,57,1],[221,4,221,53,1],[222,4,222,98,1],[223,4,223,70,1],[224,4,224,49,1],[225,4,225,69,1],[226,4,226,80,1],[227,3,227,4,1],[234,4,234,36,1],[235,4,235,30,1],[235,67,235,69,1],[236,4,236,33,1],[237,4,237,56,1],[239,4,239,57,1],[240,4,240,53,1],[242,4,242,42,1],[243,4,243,30,1],[244,4,244,31,1],[245,4,245,40,1],[246,3,246,4,1],[94,30,94,88,1],[102,30,102,108,1],[113,30,113,67,1],[132,30,132,67,1],[154,30,154,67,1],[178,30,178,67,1],[194,30,194,67,1],[216,30,216,67,1],[235,30,235,67,1]]);
    </script>
  </body>
</html>