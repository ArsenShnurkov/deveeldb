<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.sql.expressions\expressionstringbuilder.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

using Deveel.Data.Sql.Objects;
using Deveel.Data.Types;

namespace Deveel.Data.Sql.Expressions {
	class ExpressionStringBuilder : SqlExpressionVisitor {
		private readonly StringBuilder builder;
		private bool rootQuery = true;

		public ExpressionStringBuilder() {
			builder = new StringBuilder();
		}

		public string ToSqlString(SqlExpression expression) {
			rootQuery = expression is SqlQueryExpression;

			Visit(expression);
			return builder.ToString();
		}

		public override SqlExpression VisitAssign(SqlAssignExpression assign) {
			builder.Append(assign.Reference);
			builder.Append(&quot; = &quot;);
			Visit(assign.ValueExpression);

			return assign;
		}

		public override SqlExpression VisitBinary(SqlBinaryExpression binaryEpression) {
			Visit(binaryEpression.Left);

			var binaryOpString = GetBinaryOperatorString(binaryEpression.ExpressionType);
			builder.AppendFormat(&quot; {0} &quot;, binaryOpString);

			Visit(binaryEpression.Right);

			return binaryEpression;
		}

		private static string GetBinaryOperatorString(SqlExpressionType expressionType) {
			switch (expressionType) {
				case SqlExpressionType.Add:
					return &quot;+&quot;;
				case SqlExpressionType.Subtract:
					return &quot;-&quot;;
				case SqlExpressionType.Divide:
					return &quot;/&quot;;
				case SqlExpressionType.Multiply:
					return &quot;*&quot;;
				case SqlExpressionType.Modulo:
					return &quot;%&quot;;
				case SqlExpressionType.Equal:
					return &quot;=&quot;;
				case SqlExpressionType.NotEqual:
					return &quot;&lt;&gt;&quot;;
				case SqlExpressionType.GreaterThan:
					return &quot;&gt;&quot;;
				case SqlExpressionType.GreaterOrEqualThan:
					return &quot;&gt;=&quot;;
				case SqlExpressionType.SmallerThan:
					return &quot;&lt;&quot;;
				case SqlExpressionType.SmallerOrEqualThan:
					return &quot;&lt;=&quot;;
				case SqlExpressionType.Is:
					return &quot;IS&quot;;
				case SqlExpressionType.IsNot:
					return &quot;IS NOT&quot;;
				case SqlExpressionType.Like:
					return &quot;LIKE&quot;;
				case SqlExpressionType.NotLike:
					return &quot;NOT LIKE&quot;;
				case SqlExpressionType.AllEqual:
					return &quot;= ALL&quot;;
				case SqlExpressionType.AllNotEqual:
					return &quot;&lt;&gt; ALL&quot;;
				case SqlExpressionType.AllGreaterThan:
					return &quot;&gt; ALL&quot;;
				case SqlExpressionType.AllGreaterOrEqualThan:
					return &quot;&gt;= ALL&quot;;
				case SqlExpressionType.AllSmallerThan:
					return &quot;&lt; ALL&quot;;
				case SqlExpressionType.AllSmallerOrEqualThan:
					return &quot;&lt;= ALL&quot;;
				case SqlExpressionType.AnyEqual:
					return &quot;= ANY&quot;;
				case SqlExpressionType.AnyNotEqual:
					return &quot;&lt;&gt; ANY&quot;;
				case SqlExpressionType.AnyGreaterThan:
					return &quot;&gt; ANY&quot;;
				case SqlExpressionType.AnyGreaterOrEqualThan:
					return &quot;&gt;= ANY&quot;;
				case SqlExpressionType.AnySmallerThan:
					return &quot;&lt; ANY&quot;;
				case SqlExpressionType.AnySmallerOrEqualThan:
					return &quot;&lt;= ANY&quot;;
				case SqlExpressionType.Or:
					return &quot;OR&quot;;
				case SqlExpressionType.And:
					return &quot;AND&quot;;
				case SqlExpressionType.XOr:
					return &quot;XOR&quot;;
				default:
					throw new NotSupportedException();
			}
		}

		public override SqlExpression VisitCast(SqlCastExpression castExpression) {
			builder.Append(&quot;CAST &quot;);
			Visit(castExpression.Value);
			builder.Append(&quot; AS &quot;);
			builder.Append(castExpression.DataType);

			return base.VisitCast(castExpression);
		}

		public override SqlExpression VisitConditional(SqlConditionalExpression conditional) {
			return base.VisitConditional(conditional);
		}

		public override SqlExpression VisitConstant(SqlConstantExpression constant) {
			var value = constant.Value;
			if (value.Type is QueryType) {
				// TODO: convert to sql string also a QUERY PLAN
				builder.Append(&quot;({QUERY})&quot;);
			} else if (value.Type is ArrayType) {
				var array = (SqlArray) value.Value;
				if (array.IsNull) {
					builder.Append(&quot;NULL&quot;);
				} else {
					builder.Append(&quot;(&quot;);
					var sz = array.Length;
					for (int i = 0; i &lt; sz; i++) {
						Visit(array[i]);

						if (i &lt; sz - 1)
							builder.Append(&quot;, &quot;);
					}
					builder.Append(&quot;)&quot;);
				}
			} else if (value.Type is NullType) {
				builder.Append(&quot;NULL&quot;);
			} else if (value.Type.IsPrimitive) {
				if (value.IsNull) {
					builder.Append(&quot;NULL&quot;);
				} else {
					builder.Append(value.Value);
				}
			}

			return constant;
		}

		public override SqlExpression VisitFunctionCall(SqlFunctionCallExpression expression) {
			builder.Append(expression.FunctioName);
			builder.Append(&quot;(&quot;);

			if (expression.Arguments != null &amp;&amp;
			    expression.Arguments.Length &gt; 0) {
				var args = expression.Arguments;
				var argc = args.Length;

				for (int i = 0; i &lt; argc; i++) {
					Visit(args[i]);

					if (i &lt; argc - 1)
						builder.Append(&quot;, &quot;);
				}
			}

			builder.Append(&quot;)&quot;);

			return expression;
		}

		private void PrintQueryColumns(IEnumerable&lt;SelectColumn&gt; selectColumns) {
			var columns = selectColumns.ToArray();
			var sz = columns.Length;
			for (int i = 0; i &lt; sz; i++) {
				var column = columns[i];

				if (column.IsGlob) {
					if (column.IsAll) {
						builder.Append(&quot;*&quot;);
					} else {
						builder.AppendFormat(&quot;{0}.*&quot;, column.TableName);
					}
				} else {
					Visit(column.Expression);
				}

				if (!String.IsNullOrEmpty(column.Alias))
					builder.AppendFormat(&quot; AS {0}&quot;, column.Alias);

				if (i &lt; sz - 1)
					builder.Append(&quot;, &quot;);
			}
		}

		public override SqlExpression VisitQuery(SqlQueryExpression query) {
			if (!rootQuery)
				builder.Append(&quot;(&quot;);

			builder.Append(&quot;SELECT &quot;);
			if (query.Distinct)
				builder.Append(&quot;DISTINCT &quot;);

			PrintQueryColumns(query.SelectColumns);
			builder.Append(&quot; &quot;);

			PrintFromClause(query.FromClause);

			if (query.WhereExpression != null) {
				builder.Append(&quot; WHERE &quot;);
				Visit(query.WhereExpression);
			}

			if (query.GroupBy != null) {
				builder.Append(&quot; GROUP BY &quot;);
				VisitExpressionList(query.GroupBy.ToArray());

				if (query.HavingExpression != null) {
					builder.Append(&quot; HVAING &quot;);
					Visit(query.HavingExpression);
				}
			}

			if (query.GroupMax != null) {
				builder.Append(&quot; GROUP MAX &quot;);
				builder.Append(query.GroupMax.FullName);
			}

			// TODO: COMPOSITE ...

			if (!rootQuery)
				builder.Append(&quot;)&quot;);

			return query;
		}

		private void PrintFromClause(FromClause fromClause) {
			builder.Append(&quot;FROM &quot;);

			var tables = fromClause.AllTables.ToList();
			for (int i = 0; i &lt; tables.Count; i++) {
				var source = tables[i];

				JoinPart joinPart = null;

				if (i &gt; 0) {
					joinPart = fromClause.GetJoinPart(i - 1);
					if (joinPart != null) {
						if (joinPart.JoinType == JoinType.Inner) {
							builder.Append(&quot; INNER JOIN &quot;);
						} else if (joinPart.JoinType == JoinType.Right) {
							builder.Append(&quot; RIGHT OUTER JOIN &quot;);
						} else if (joinPart.JoinType == JoinType.Left) {
							builder.Append(&quot; LEFT OUTER JOIN &quot;);
						} else if (joinPart.JoinType == JoinType.Full) {
							builder.Append(&quot; FULL OUTER JOINT &quot;);
						}
					}
				}

				if (source.IsSubQuery) {
					builder.Append(&quot;(&quot;);
					Visit(source.SubQuery);
					builder.Append(&quot;)&quot;);
				} else {
					builder.Append(source.Name);
				}

				if (!String.IsNullOrEmpty(source.Alias)) {
					builder.Append(&quot; AS &quot;);
					builder.Append(source.Alias);
				}

				if (i &lt; tables.Count - 1) {
					if (joinPart == null) {
						builder.Append(&quot;, &quot;);
					} else {
						builder.Append(&quot; ON &quot;);
						Visit(joinPart.OnExpression);
					}
				}
			}
		}

		public override SqlExpression VisitReference(SqlReferenceExpression reference) {
			builder.Append(reference.ReferenceName);
			return reference;
		}

		public override SqlExpression VisitTuple(SqlTupleExpression expression) {
			builder.Append(&quot;(&quot;);

			var sz = expression.Expressions.Length;
			for (int i = 0; i &lt; sz; i++) {
				Visit(expression.Expressions[i]);
				if (i &lt; sz - 1)
					builder.Append(&quot;, &quot;);
			}

			builder.Append(&quot;)&quot;);
			return expression;
		}

		public override SqlExpression VisitUnary(SqlUnaryExpression unary) {
			var unaryOpString = GetUnaryOperatorString(unary.ExpressionType);
			builder.Append(unaryOpString);
			builder.Append(&quot; &quot;);
			Visit(unary.Operand);

			return unary;
		}

		private string GetUnaryOperatorString(SqlExpressionType unaryType) {
			switch (unaryType) {
				case SqlExpressionType.UnaryPlus:
					return &quot;+&quot;;
				case SqlExpressionType.Negate:
					return &quot;-&quot;;
				case SqlExpressionType.Not:
					return &quot;NOT&quot;;
				default:
					throw new NotSupportedException();
			}
		}

		public override SqlExpression VisitVariableReference(SqlVariableReferenceExpression reference) {
			builder.AppendFormat(&quot;:{0}&quot;, reference.VariableName);
			return reference;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[26,4,26,37,0],[27,4,27,26,0],[28,4,28,34,0],[30,4,30,18,0],[49,6,49,17,0],[51,6,51,17,0],[53,6,53,17,0],[55,6,55,17,0],[57,6,57,17,0],[59,6,59,18,0],[61,6,61,17,0],[63,6,63,18,0],[65,6,65,17,0],[67,6,67,18,0],[69,6,69,18,0],[71,6,71,22,0],[73,6,73,20,0],[75,6,75,24,0],[77,6,77,21,0],[79,6,79,22,0],[81,6,81,21,0],[83,6,83,22,0],[85,6,85,21,0],[87,6,87,22,0],[89,6,89,21,0],[91,6,91,22,0],[93,6,93,21,0],[95,6,95,22,0],[97,6,97,21,0],[99,6,99,22,0],[101,6,101,18,0],[103,6,103,19,0],[105,6,105,19,0],[107,6,107,40,0],[112,4,112,28,0],[113,4,113,32,0],[114,4,114,27,0],[115,4,115,44,0],[117,4,117,42,0],[121,4,121,46,0],[128,5,128,33,0],[130,5,130,40,0],[131,5,131,22,0],[132,6,132,29,0],[134,6,134,26,0],[135,6,135,28,0],[136,11,136,21,0],[137,7,137,23,0],[139,7,139,22,0],[140,8,140,29,0],[136,30,136,33,0],[136,22,136,28,0],[142,6,142,26,0],[145,5,145,28,0],[148,6,148,29,0],[158,4,158,43,0],[159,4,159,24,0],[161,4,162,40,0],[163,5,163,37,0],[164,5,164,28,0],[166,10,166,20,0],[167,6,167,21,0],[169,6,169,23,0],[170,7,170,28,0],[166,31,166,34,0],[166,21,166,29,0],[174,4,174,24,0],[176,4,176,22,0],[180,4,180,42,0],[181,4,181,28,0],[182,9,182,19,0],[183,5,183,29,0],[185,5,185,23,0],[186,6,186,23,0],[187,7,187,27,0],[189,7,189,55,0],[192,6,192,31,0],[195,5,195,45,0],[196,6,196,52,0],[198,5,198,20,0],[199,6,199,27,0],[182,28,182,31,0],[182,20,182,26,0],[201,3,201,4,0],[204,4,204,19,0],[205,5,205,25,0],[207,4,207,30,0],[208,4,208,23,0],[209,5,209,33,0],[211,4,211,43,0],[212,4,212,24,0],[214,4,214,38,0],[216,4,216,38,0],[217,5,217,31,0],[218,5,218,34,0],[221,4,221,30,0],[222,5,222,34,0],[223,5,223,50,0],[225,5,225,40,0],[226,6,226,33,0],[227,6,227,36,0],[231,4,231,31,0],[232,5,232,35,0],[233,5,233,45,0],[238,4,238,19,0],[239,5,239,25,0],[241,4,241,17,0],[245,4,245,28,0],[247,4,247,47,0],[248,9,248,19,0],[249,5,249,28,0],[251,5,251,30,0],[253,5,253,15,0],[254,6,254,47,0],[255,6,255,27,0],[256,7,256,47,0],[257,8,257,39,0],[258,14,258,54,0],[259,8,259,45,0],[260,14,260,53,0],[261,8,261,44,0],[262,14,262,53,0],[263,8,263,45,0],[268,5,268,27,0],[269,6,269,26,0],[270,6,270,29,0],[271,6,271,26,0],[273,6,273,34,0],[276,5,276,45,0],[277,6,277,29,0],[278,6,278,35,0],[281,5,281,30,0],[282,6,282,27,0],[283,7,283,28,0],[285,7,285,30,0],[286,7,286,36,0],[248,38,248,41,0],[248,20,248,36,0],[290,3,290,4,0],[293,4,293,44,0],[294,4,294,21,0],[298,4,298,24,0],[300,4,300,43,0],[301,9,301,19,0],[302,5,302,38,0],[303,5,303,20,0],[304,6,304,27,0],[301,28,301,31,0],[301,20,301,26,0],[307,4,307,24,0],[308,4,308,22,0],[312,4,312,69,0],[313,4,313,34,0],[314,4,314,24,0],[315,4,315,25,0],[317,4,317,17,0],[321,4,321,22,0],[323,6,323,17,0],[325,6,325,17,0],[327,6,327,19,0],[329,6,329,40,0],[334,4,334,57,0],[335,4,335,21,0],[12,3,12,33,1],[14,3,14,35,1],[15,4,15,34,1],[16,3,16,4,1],[19,4,19,49,1],[21,4,21,22,1],[22,4,22,30,1],[34,4,34,32,1],[36,4,36,81,1],[37,4,37,50,1],[39,4,39,33,1],[41,4,41,27,1],[45,4,45,27,1],[47,6,47,17,1],[125,4,125,31,1],[126,4,126,32,1],[129,11,129,39,1],[144,11,144,38,1],[146,11,146,38,1],[147,5,147,22,1],[150,6,150,34,1],[154,4,154,20,1]]);
    </script>
  </body>
</html>