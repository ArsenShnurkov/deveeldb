<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.sql.statements\columnchecker.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;

using Deveel.Data.DbSystem;
using Deveel.Data.Sql.Expressions;
using Deveel.Data.Sql.Query;

namespace Deveel.Data.Sql.Statements {
	abstract class ColumnChecker {
		public string StripTableName(string tableDomain, string column) {
			var index = column.IndexOf(&#39;.&#39;);

			if (index != -1) {
				var columnPrefix = column.Substring(0, index);
				if (!columnPrefix.Equals(tableDomain))
					throw new InvalidOperationException(String.Format(&quot;Column &#39;{0}&#39; is not within the expected table&#39;{1}&#39;&quot;, 
						column, tableDomain));

				column = column.Substring(index + 1);
			}

			return column;
		}

		public IEnumerable&lt;string&gt; StripColumnList(string tableDomain, IEnumerable&lt;string&gt; columnList) {
			return columnList.Select(x =&gt; StripTableName(tableDomain, x));
		}

		public abstract string ResolveColumnName(string columnName);

		public SqlExpression CheckExpression(SqlExpression expression) {
			var expChecker = new ExpressionChecker(this);
			return expChecker.Visit(expression);
		}

		public IEnumerable&lt;string&gt; CheckColumns(IEnumerable&lt;string&gt; columnNames) {
			var result = new List&lt;string&gt;();

			foreach (var columnName in columnNames) {
				var resolved = ResolveColumnName(columnName);
				if (resolved == null)
					throw new InvalidOperationException(String.Format(&quot;Column &#39;{0}&#39; not found in table.&quot;, columnName));

				result.Add(resolved);
			}

			return result.AsReadOnly();
		}

		public static ColumnChecker Default(IQueryContext context, ObjectName tableName) {
			var table = context.GetTable(tableName);
			if (table == null)
				throw new InvalidOperationException(String.Format(&quot;Table &#39;{0}&#39; not found in the context.&quot;, tableName));

			var tableInfo = table.TableInfo;
			var ignoreCase = context.IgnoreIdentifiersCase();

			return new DefaultChecker(tableInfo, ignoreCase);
		}

		#region DefaultChecker

		class DefaultChecker : ColumnChecker {
			private readonly TableInfo tableInfo;
			private readonly bool ignoreCase;

			public DefaultChecker(TableInfo tableInfo, bool ignoreCase) {
				this.tableInfo = tableInfo;
				this.ignoreCase = ignoreCase;
			}

			public override string ResolveColumnName(string columnName) {
				var comparison = ignoreCase ? StringComparison.OrdinalIgnoreCase : StringComparison.Ordinal;
				string foundColumn = null;

				foreach (var columnInfo in tableInfo) {
					if (foundColumn != null)
						throw new InvalidOperationException(String.Format(&quot;Column name &#39;{0}&#39; caused an ambiguous match in table.&quot;, columnName));

					if (String.Equals(columnInfo.ColumnName, columnName, comparison))
						foundColumn = columnInfo.ColumnName;
				}

				return foundColumn;
			}
		}

		#endregion

		#region ExpressionChecker

		class ExpressionChecker : SqlExpressionVisitor {
			private readonly ColumnChecker checker;

			public ExpressionChecker(ColumnChecker checker) {
				this.checker = checker;
			}

			public override SqlExpression VisitReference(SqlReferenceExpression reference) {
				var refName = reference.ReferenceName;
				var origColumn = refName.Name;
				var resolvedColumn = checker.ResolveColumnName(origColumn);
				if (resolvedColumn == null)
					throw new InvalidOperationException(String.Format(&quot;Column &#39;{0} not found in table.&quot;, origColumn));

				if (!origColumn.Equals(resolvedColumn))
					refName = new ObjectName(refName.Parent, resolvedColumn);

				return SqlExpression.Reference(refName);
			}

			public override SqlExpression VisitQuery(SqlQueryExpression query) {
				throw new InvalidOperationException(&quot;Sub-queries are not permitted in a CHECK expression.&quot;);
			}
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[15,5,15,51,0],[16,5,16,43,0],[17,6,18,29,0],[20,5,20,42,0],[27,4,27,34,0],[27,64,27,66,0],[38,4,38,36,0],[40,31,40,42,0],[40,13,40,27,0],[41,5,41,50,0],[42,5,42,26,0],[43,6,43,105,0],[45,5,45,26,0],[40,28,40,30,0],[48,4,48,31,0],[52,4,52,44,0],[53,4,53,22,0],[54,5,54,108,0],[56,4,56,36,0],[57,4,57,53,0],[59,4,59,53,0],[68,4,68,63,0],[69,5,69,32,0],[70,5,70,34,0],[71,4,71,5,0],[74,5,74,97,0],[75,5,75,31,0],[77,32,77,41,0],[77,14,77,28,0],[78,6,78,30,0],[79,7,79,127,0],[81,6,81,71,0],[82,7,82,43,0],[77,29,77,31,0],[85,5,85,24,0],[101,5,101,43,0],[102,5,102,35,0],[103,5,103,64,0],[104,5,104,32,0],[105,6,105,104,0],[107,5,107,44,0],[108,6,108,63,0],[110,5,110,45,0],[114,5,114,97,0],[27,34,27,64,0],[12,4,12,36,1],[14,4,14,20,1],[23,4,23,18,1],[33,4,33,49,1],[34,4,34,40,1],[96,4,96,51,1],[97,5,97,28,1],[98,4,98,5,1]]);
    </script>
  </body>
</html>