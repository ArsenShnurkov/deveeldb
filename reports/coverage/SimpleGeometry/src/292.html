<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.store\fixedrecordlist.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections.Generic;
using System.IO;

namespace Deveel.Data.Store {
	public sealed class FixedRecordList {
		private const int Magic = 0x087131AA;

		private readonly IStore store;
		private readonly int elementSize;

		private long headerAreaId;
		private IArea headerArea;

		// Pointers to the blocks in the list block.
		private readonly long[] blockElements;
		private readonly IArea[] blockAreas;

		public FixedRecordList(IStore store, int elementSize) {
			this.store = store;
			this.elementSize = elementSize;
			blockElements = new long[64];
			blockAreas = new IArea[64];
		}

		public int BlockCount { get; private set; }

		public long NodeCount {
			get { return BlockFirstPosition(BlockCount); }
		}

		private void UpdateListHeaderArea() {
			headerArea.Position = 4;
			headerArea.WriteInt4(BlockCount);
			headerArea.Position = 16;
			for (int i = 0; i &lt; BlockCount; ++i) {
				headerArea.WriteInt8(blockElements[i]);
			}
			headerArea.Flush();
		}

		public long Create() {
			// Allocate space for the list header (8 + 8 + (64 * 8))
			IArea writer = store.CreateArea(528);
			headerAreaId = writer.Id;
			writer.WriteInt4(Magic);
			writer.Flush();

			headerArea = store.GetArea(headerAreaId);
			BlockCount = 0;
			UpdateListHeaderArea();

			return headerAreaId;
		}

		public void Open(long listPointer) {
			headerAreaId = listPointer;
			headerArea = store.GetArea(headerAreaId);

			int magic = headerArea.ReadInt4(); // MAGIC
			if (magic != Magic)
				throw new IOException(&quot;Incorrect magic for list block. [magic=&quot; + magic + &quot;]&quot;);

			BlockCount = headerArea.ReadInt4();
			headerArea.ReadInt8(); // Delete Chain Head
			for (int i = 0; i &lt; BlockCount; ++i) {
				long blockPointer = headerArea.ReadInt8();
				blockElements[i] = blockPointer;
				blockAreas[i] = store.GetArea(blockPointer);
			}
		}

		public long ReadDeleteHead() {
			headerArea.Position = 8;
			return headerArea.ReadInt8();
		}

		public void WriteDeleteHead(long value) {
			headerArea.Position = 8;
			headerArea.WriteInt8(value);
			headerArea.Flush();
		}

		public IArea GetRecord(long recordNumber) {
			// What block is this record in?
			int bit = 0;
			long work = recordNumber + 32;
			while (work != 0) {
				work = work &gt;&gt; 1;
				++bit;
			}

			long startOffset = (1 &lt;&lt; (bit - 1)) - 32;
			int blockOffset = bit - 6;
			long recordOffset = recordNumber - startOffset;

			// Get the pointer to the block that contains this record status
			IArea blockArea = blockAreas[blockOffset];
			blockArea.Position = (int) (recordOffset*elementSize);
			return blockArea;
		}

		public long BlockNodeCount(int blockNumber) {
			return 32L &lt;&lt; blockNumber;
		}

		public long BlockFirstPosition(int blockNumber) {
			// For example, this first node of block 0 is 0, the first node of block 1 is
			// 32, the first node of block 2 is 96, etc.
			long startIndex = 0;
			int i = blockNumber;
			long diff = 32;
			while (i &gt; 0) {
				startIndex = startIndex + diff;
				diff = diff &lt;&lt; 1;
				--i;
			}
			return startIndex;
		}

		public void IncreaseSize() {
			// The size of the block
			long sizeOfBlock = 32L &lt;&lt; BlockCount;

			// Allocate the new block in the store
			var area = store.CreateArea(sizeOfBlock * elementSize);
			var blockId = area.Id;
			area.Flush();

			var blockArea = store.GetArea(blockId);

			// Update the block list
			blockElements[BlockCount] = blockId;
			blockAreas[BlockCount] = blockArea;
			++BlockCount;

			// Update the list header,
			UpdateListHeaderArea();
		}

		public void DecreaseSize() {
			--BlockCount;
			// Free the top block
			store.DeleteArea(blockElements[BlockCount]);

			// Help the GC
			blockAreas[BlockCount] = null;
			blockElements[BlockCount] = 0;

			// Update the list header.
			UpdateListHeaderArea();
		}

		public void GetAreasUsed(IList&lt;long&gt; usedAreas) {
			usedAreas.Add(headerAreaId);
			for (int i = 0; i &lt; BlockCount; ++i) {
				usedAreas.Add(blockElements[i]);
			}
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[78,5,78,84,0],[158,4,158,17,0],[160,4,160,48,0],[163,4,163,34,0],[164,4,164,34,0],[167,4,167,27,0],[168,3,168,4,0],[171,4,171,32,0],[172,9,172,19,0],[173,5,173,37,0],[172,36,172,39,0],[172,20,172,34,0],[175,3,175,4,0],[35,3,35,56,1],[36,4,36,23,1],[37,4,37,35,1],[38,4,38,33,1],[39,4,39,31,1],[40,3,40,4,1],[45,10,45,48,1],[49,4,49,28,1],[50,4,50,37,1],[51,4,51,29,1],[52,9,52,19,1],[53,5,53,44,1],[52,36,52,39,1],[52,20,52,34,1],[55,4,55,23,1],[56,3,56,4,1],[60,4,60,41,1],[61,4,61,29,1],[62,4,62,28,1],[63,4,63,19,1],[65,4,65,45,1],[66,4,66,19,1],[67,4,67,27,1],[69,4,69,24,1],[73,4,73,31,1],[74,4,74,45,1],[76,4,76,38,1],[77,4,77,23,1],[80,4,80,39,1],[81,4,81,26,1],[82,9,82,19,1],[83,5,83,47,1],[84,5,84,37,1],[85,5,85,49,1],[82,36,82,39,1],[82,20,82,34,1],[87,3,87,4,1],[90,4,90,28,1],[91,4,91,33,1],[95,4,95,28,1],[96,4,96,32,1],[97,4,97,23,1],[98,3,98,4,1],[102,4,102,16,1],[103,4,103,34,1],[105,5,105,22,1],[106,5,106,11,1],[104,4,104,21,1],[109,4,109,45,1],[110,4,110,30,1],[111,4,111,51,1],[114,4,114,46,1],[115,4,115,58,1],[116,4,116,21,1],[120,4,120,30,1],[126,4,126,24,1],[127,4,127,24,1],[128,4,128,19,1],[130,5,130,36,1],[131,5,131,22,1],[132,5,132,9,1],[129,4,129,17,1],[134,4,134,22,1],[139,4,139,41,1],[142,4,142,59,1],[143,4,143,26,1],[144,4,144,17,1],[146,4,146,43,1],[149,4,149,40,1],[150,4,150,39,1],[151,4,151,17,1],[154,4,154,27,1],[155,3,155,4,1]]);
    </script>
  </body>
</html>