<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb-nunit\deveel.data.sql.statements\createtablestatementtests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;

using Deveel.Data.Configuration;
using Deveel.Data.DbSystem;
using Deveel.Data.Security;
using Deveel.Data.Sql.Expressions;
using Deveel.Data.Types;

using NUnit.Framework;

namespace Deveel.Data.Sql.Statements {
	[TestFixture]
	public class CreateTableStatementTests {
		private IUserSession session;
		private IQueryContext context;

		[SetUp]
		public void SetUp() {
			var systemContext = new SystemContext(DbConfig.Default);
			var dbContext = new DatabaseContext(systemContext, &quot;testdb&quot;);
			var database = new Database(dbContext);
			database.Create(&quot;SA&quot;, &quot;12345&quot;);
			database.Open();

			session = database.CreateSession(User.System);
			context = new SessionQueryContext(session);
		}

		[Test]
		public void ParseSimpleCreate() {
			const string sql = &quot;CREATE TABLE test (id INT, name VARCHAR)&quot;;

			IEnumerable&lt;SqlStatement&gt; statements = null;
			Assert.DoesNotThrow(() =&gt; statements = SqlStatement.Parse(sql));
			Assert.IsNotNull(statements);

			var list = statements.ToList();

			Assert.AreEqual(1, list.Count);

			var statement = list[0];

			Assert.IsNotNull(statement);
			Assert.IsInstanceOf&lt;CreateTableStatement&gt;(statement);

			var createTable = (CreateTableStatement) statement;
			Assert.AreEqual(2, createTable.Columns.Count);

			var columns = createTable.Columns;

			Assert.AreEqual(&quot;id&quot;, columns[0].ColumnName);
			Assert.AreEqual(SqlTypeCode.Integer, columns[0].ColumnType.SqlType);

			Assert.AreEqual(&quot;name&quot;, columns[1].ColumnName);
			Assert.IsInstanceOf&lt;StringType&gt;(columns[1].ColumnType);
		}

		[Test]
		public void SimpleCreate() {
			const string sql = &quot;CREATE TABLE test (id INT, name VARCHAR)&quot;;

			IEnumerable&lt;SqlStatement&gt; statements = null;
			Assert.DoesNotThrow(() =&gt; statements = SqlStatement.Parse(sql));
			Assert.IsNotNull(statements);

			var list = statements.ToList();

			Assert.AreEqual(1, list.Count);

			var statement = list[0];

			Assert.IsNotNull(statement);
			Assert.IsInstanceOf&lt;CreateTableStatement&gt;(statement);

			ITable result = null;
			Assert.DoesNotThrow(() =&gt; result = statement.Evaluate(context));
			Assert.IsNotNull(result);
			Assert.AreEqual(1, result.RowCount);
		}

		[Test]
		public void WithColumnDefault() {
			const string sql = &quot;CREATE TABLE test (id INT, name VARCHAR DEFAULT (67 * 90)+22, date TIMESTAMP DEFAULT GetDate())&quot;;

			IEnumerable&lt;SqlStatement&gt; statements = null;
			Assert.DoesNotThrow(() =&gt; statements = SqlStatement.Parse(sql));
			Assert.IsNotNull(statements);

			var list = statements.ToList();

			Assert.AreEqual(1, list.Count);

			var statement = list[0];

			Assert.IsNotNull(statement);
			Assert.IsInstanceOf&lt;CreateTableStatement&gt;(statement);

			ITable result = null;
			Assert.DoesNotThrow(() =&gt; result = statement.Evaluate(context));
			Assert.IsNotNull(result);
			Assert.AreEqual(1, result.RowCount);
		}

		[Test]
		public void ParseWithColumnDefault() {
			const string sql = &quot;CREATE TABLE test (id INT, name VARCHAR DEFAULT (67 * 90)+22, date TIMESTAMP DEFAULT GetDate())&quot;;

			IEnumerable&lt;SqlStatement&gt; statements = null;
			Assert.DoesNotThrow(() =&gt; statements = SqlStatement.Parse(sql));
			Assert.IsNotNull(statements);

			var list = statements.ToList();

			Assert.AreEqual(1, list.Count);

			var statement = list[0];

			Assert.IsNotNull(statement);
			Assert.IsInstanceOf&lt;CreateTableStatement&gt;(statement);

			var createTable = (CreateTableStatement)statement;
			Assert.AreEqual(3, createTable.Columns.Count);

			var columns = createTable.Columns;

			Assert.AreEqual(&quot;id&quot;, columns[0].ColumnName);
			Assert.AreEqual(SqlTypeCode.Integer, columns[0].ColumnType.SqlType);

			Assert.AreEqual(&quot;name&quot;, columns[1].ColumnName);
			Assert.IsInstanceOf&lt;StringType&gt;(columns[1].ColumnType);
			Assert.IsTrue(columns[1].HasDefaultExpression);
			Assert.IsInstanceOf&lt;SqlBinaryExpression&gt;(columns[1].DefaultExpression);

			Assert.AreEqual(&quot;date&quot;, columns[2].ColumnName);
			Assert.IsInstanceOf&lt;DateType&gt;(columns[2].ColumnType);
			Assert.IsTrue(columns[1].HasDefaultExpression);
			Assert.IsInstanceOf&lt;SqlFunctionCallExpression&gt;(columns[2].DefaultExpression);
		}

		[Test]
		public void ParseWithColumnIdentity() {
			const string sql = &quot;CREATE TABLE test (id INT IDENTITY, name VARCHAR NOT NULL)&quot;;

			IEnumerable&lt;SqlStatement&gt; statements = null;
			Assert.DoesNotThrow(() =&gt; statements = SqlStatement.Parse(sql));
			Assert.IsNotNull(statements);

			var list = statements.ToList();

			Assert.AreEqual(1, list.Count);

			var statement = list[0];

			Assert.IsNotNull(statement);
			Assert.IsInstanceOf&lt;CreateTableStatement&gt;(statement);

			var createTable = (CreateTableStatement)statement;
			Assert.AreEqual(2, createTable.Columns.Count);

			var columns = createTable.Columns;

			Assert.AreEqual(&quot;id&quot;, columns[0].ColumnName);
			Assert.AreEqual(SqlTypeCode.Integer, columns[0].ColumnType.SqlType);
			Assert.IsNotNull(columns[0].DefaultExpression);
			Assert.IsInstanceOf&lt;SqlFunctionCallExpression&gt;(columns[0].DefaultExpression);

			Assert.AreEqual(&quot;name&quot;, columns[1].ColumnName);
			Assert.IsInstanceOf&lt;StringType&gt;(columns[1].ColumnType);
			Assert.IsTrue(columns[1].IsNotNull);
		}

		[Test]
		public void ParseWithColumnConstraints() {
			const string sql = &quot;CREATE TABLE test (id INT PRIMARY KEY, name VARCHAR NOT NULL)&quot;;

			IEnumerable&lt;SqlStatement&gt; statements = null;
			Assert.DoesNotThrow(() =&gt; statements = SqlStatement.Parse(sql));
			Assert.IsNotNull(statements);

			var list = statements.ToList();

			Assert.AreEqual(2, list.Count);
		}

		[Test]
		public void ParseWithColumnAndTableConstraints() {
			const string sql = &quot;CREATE TABLE test (id INT PRIMARY KEY, name VARCHAR NOT NULL, CONSTRAINT uk_test UNIQUE(name))&quot;;

			IEnumerable&lt;SqlStatement&gt; statements = null;
			Assert.DoesNotThrow(() =&gt; statements = SqlStatement.Parse(sql));
			Assert.IsNotNull(statements);

			var list = statements.ToList();

			Assert.AreEqual(3, list.Count);
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,4,21,60,1],[22,4,22,65,1],[23,4,23,43,1],[24,4,24,35,1],[25,4,25,20,1],[27,4,27,50,1],[28,4,28,47,1],[29,3,29,4,1],[35,4,35,48,1],[36,4,36,30,1],[36,66,36,68,1],[37,4,37,33,1],[39,4,39,35,1],[41,4,41,35,1],[43,4,43,28,1],[45,4,45,32,1],[46,4,46,57,1],[48,4,48,55,1],[49,4,49,50,1],[51,4,51,38,1],[53,4,53,49,1],[54,4,54,72,1],[56,4,56,51,1],[57,4,57,59,1],[58,3,58,4,1],[64,4,64,48,1],[65,4,65,30,1],[65,66,65,68,1],[66,4,66,33,1],[68,4,68,35,1],[70,4,70,35,1],[72,4,72,28,1],[74,4,74,32,1],[75,4,75,57,1],[77,4,77,25,1],[78,4,78,30,1],[78,66,78,68,1],[79,4,79,29,1],[80,4,80,40,1],[81,3,81,4,1],[87,4,87,48,1],[88,4,88,30,1],[88,66,88,68,1],[89,4,89,33,1],[91,4,91,35,1],[93,4,93,35,1],[95,4,95,28,1],[97,4,97,32,1],[98,4,98,57,1],[100,4,100,25,1],[101,4,101,30,1],[101,66,101,68,1],[102,4,102,29,1],[103,4,103,40,1],[104,3,104,4,1],[110,4,110,48,1],[111,4,111,30,1],[111,66,111,68,1],[112,4,112,33,1],[114,4,114,35,1],[116,4,116,35,1],[118,4,118,28,1],[120,4,120,32,1],[121,4,121,57,1],[123,4,123,54,1],[124,4,124,50,1],[126,4,126,38,1],[128,4,128,49,1],[129,4,129,72,1],[131,4,131,51,1],[132,4,132,59,1],[133,4,133,51,1],[134,4,134,75,1],[136,4,136,51,1],[137,4,137,57,1],[138,4,138,51,1],[139,4,139,81,1],[140,3,140,4,1],[146,4,146,48,1],[147,4,147,30,1],[147,66,147,68,1],[148,4,148,33,1],[150,4,150,35,1],[152,4,152,35,1],[154,4,154,28,1],[156,4,156,32,1],[157,4,157,57,1],[159,4,159,54,1],[160,4,160,50,1],[162,4,162,38,1],[164,4,164,49,1],[165,4,165,72,1],[166,4,166,51,1],[167,4,167,81,1],[169,4,169,51,1],[170,4,170,59,1],[171,4,171,40,1],[172,3,172,4,1],[178,4,178,48,1],[179,4,179,30,1],[179,66,179,68,1],[180,4,180,33,1],[182,4,182,35,1],[184,4,184,35,1],[185,3,185,4,1],[191,4,191,48,1],[192,4,192,30,1],[192,66,192,68,1],[193,4,193,33,1],[195,4,195,35,1],[197,4,197,35,1],[198,3,198,4,1],[36,30,36,66,1],[65,30,65,66,1],[78,30,78,66,1],[88,30,88,66,1],[101,30,101,66,1],[111,30,111,66,1],[147,30,147,66,1],[179,30,179,66,1],[192,30,192,66,1]]);
    </script>
  </body>
</html>