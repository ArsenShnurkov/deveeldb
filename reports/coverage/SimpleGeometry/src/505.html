<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb-nunit\deveel.data.sql\jointabletests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2014 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.

using System;

using Deveel.Data.Configuration;
using Deveel.Data.DbSystem;
using Deveel.Data.Security;
using Deveel.Data.Sql.Expressions;
using Deveel.Data.Sql.Objects;
using Deveel.Data.Types;

using NUnit.Framework;

namespace Deveel.Data.Sql {
	[TestFixture]
	public class JoinTableTests {
		private IUserSession session;
		private IQueryContext context;

		[SetUp]
		public void SetUp() {
			var systemContext = new SystemContext(DbConfig.Default);
			var dbContext = new DatabaseContext(systemContext, &quot;testdb&quot;);
			var database = new Database(dbContext);
			database.Create(&quot;SA&quot;, &quot;12345&quot;);
			database.Open();

			session = database.CreateSession(User.System);
			context = new SessionQueryContext(session);

			CreateTestTables();
			AddTestData();
		}

		private void AddTestData() {
			var table = session.GetMutableTable(new ObjectName(new ObjectName(&quot;APP&quot;), &quot;persons&quot;));

			var row = table.NewRow();
			row[&quot;person_id&quot;] = DataObject.Integer(1);
			row[&quot;name&quot;] = DataObject.String(&quot;Antonello Provenzano&quot;);
			row[&quot;age&quot;] = DataObject.Integer(34);
			table.AddRow(row);

			row = table.NewRow();
			row[&quot;person_id&quot;] = DataObject.Integer(3);
			row[&quot;name&quot;] = DataObject.String(&quot;John Doe&quot;);
			row[&quot;age&quot;] = DataObject.Integer(56);
			table.AddRow(row);

			table = session.GetMutableTable(new ObjectName(new ObjectName(&quot;APP&quot;), &quot;codes&quot;));
			row = table.NewRow();
			row[&quot;person_id&quot;] = DataObject.Integer(1);
			row[&quot;code&quot;] = DataObject.String(&quot;123456&quot;);
			row[&quot;registered&quot;] = DataObject.Date(new SqlDateTime(2014, 01, 12));
			table.AddRow(row);
		}

		private void CreateTestTables() {
			var tableInfo = CreateFirstTable();
			session.CreateTable(tableInfo);
			session.AddPrimaryKey(tableInfo.TableName, &quot;person_id&quot;);

			tableInfo = CreateSecondTable();
			session.CreateTable(tableInfo);
		}

		private TableInfo CreateSecondTable() {
			var tableInfo = new TableInfo(new ObjectName(new ObjectName(&quot;APP&quot;), &quot;codes&quot;));
			tableInfo.AddColumn(&quot;person_id&quot;, PrimitiveTypes.Integer());
			tableInfo.AddColumn(&quot;code&quot;, PrimitiveTypes.String());
			tableInfo.AddColumn(&quot;registered&quot;, PrimitiveTypes.Date());

			return tableInfo;
		}

		private TableInfo CreateFirstTable() {
			var tableInfo = new TableInfo(new ObjectName(new ObjectName(&quot;APP&quot;), &quot;persons&quot;));
			tableInfo.AddColumn(&quot;person_id&quot;, PrimitiveTypes.Integer());
			tableInfo.AddColumn(&quot;name&quot;, PrimitiveTypes.String());
			tableInfo.AddColumn(&quot;age&quot;, PrimitiveTypes.Integer());

			return tableInfo;
		}

		[TearDown]
		public void TearDown() {
		}

		[Test]
		public void NaturalInnerJoin() {
			SqlExpression expression = null;
			Assert.DoesNotThrow(() =&gt; expression = SqlExpression.Parse(&quot;SELECT * FROM persons, codes&quot;));
			Assert.IsNotNull(expression);
			Assert.IsInstanceOf&lt;SqlQueryExpression&gt;(expression);

			SqlExpression resultExpression = null;
			Assert.DoesNotThrow(() =&gt; resultExpression = expression.Evaluate(context, null));
			Assert.IsNotNull(resultExpression);
			Assert.IsInstanceOf&lt;SqlConstantExpression&gt;(resultExpression);

			var constantExpression = (SqlConstantExpression) resultExpression;
			Assert.IsInstanceOf&lt;QueryType&gt;(constantExpression.Value.Type);

			SqlExpression tabularExpression = null;
			Assert.DoesNotThrow(() =&gt; tabularExpression = constantExpression.Evaluate(context, null));
			Assert.IsNotNull(tabularExpression);
			Assert.IsInstanceOf&lt;SqlConstantExpression&gt;(tabularExpression);

			constantExpression = (SqlConstantExpression) tabularExpression;
			var result = ((SqlTabular) constantExpression.Value.Value);

			Assert.IsNotNull(result);
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[35,4,35,60,1],[36,4,36,65,1],[37,4,37,43,1],[38,4,38,35,1],[39,4,39,20,1],[41,4,41,50,1],[42,4,42,47,1],[44,4,44,23,1],[45,4,45,18,1],[46,3,46,4,1],[49,4,49,90,1],[51,4,51,29,1],[52,4,52,45,1],[53,4,53,60,1],[54,4,54,40,1],[55,4,55,22,1],[57,4,57,25,1],[58,4,58,45,1],[59,4,59,48,1],[60,4,60,40,1],[61,4,61,22,1],[63,4,63,84,1],[64,4,64,25,1],[65,4,65,45,1],[66,4,66,46,1],[67,4,67,71,1],[68,4,68,22,1],[69,3,69,4,1],[72,4,72,39,1],[73,4,73,35,1],[74,4,74,60,1],[76,4,76,36,1],[77,4,77,35,1],[78,3,78,4,1],[81,4,81,82,1],[82,4,82,63,1],[83,4,83,57,1],[84,4,84,61,1],[86,4,86,21,1],[90,4,90,84,1],[91,4,91,63,1],[92,4,92,57,1],[93,4,93,57,1],[95,4,95,21,1],[100,3,100,4,1],[104,4,104,36,1],[105,4,105,30,1],[105,94,105,96,1],[106,4,106,33,1],[107,4,107,56,1],[109,4,109,42,1],[110,4,110,30,1],[110,83,110,85,1],[111,4,111,39,1],[112,4,112,65,1],[114,4,114,70,1],[115,4,115,66,1],[117,4,117,43,1],[118,4,118,30,1],[118,92,118,94,1],[119,4,119,40,1],[120,4,120,66,1],[122,4,122,67,1],[123,4,123,63,1],[125,4,125,29,1],[126,3,126,4,1],[105,30,105,94,1],[110,30,110,83,1],[118,30,118,92,1]]);
    </script>
  </body>
</html>