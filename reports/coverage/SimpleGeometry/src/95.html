<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.index\collatedsearchindex.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections.Generic;
using System.Collections.Specialized;

using Deveel.Data.Sql;

namespace Deveel.Data.Index {
	public abstract class CollatedSearchIndex : ColumnIndex {
		protected CollatedSearchIndex(ITable table, int columnOffset) 
			: base(table, columnOffset) {
		}

		protected virtual int Count {
			get { return Table.RowCount; }
		}

		protected virtual DataObject First {
			get { return GetValue(0); }
		}

		protected virtual DataObject Last {
			get { return GetValue(Count - 1); }
		}

		private void AssertNotReadOnly() {
			if (IsReadOnly)
				throw new InvalidOperationException(&quot;The index is read-only&quot;);
		}

		public override void Insert(int rowNumber) {
			AssertNotReadOnly();
		}

		public override void Remove(int rowNumber) {
			AssertNotReadOnly();
		}

		protected override void Dispose(bool disposing) {
		}

		protected abstract int SearchFirst(DataObject value);

		protected abstract int SearchLast(DataObject value);

		protected virtual IEnumerable&lt;int&gt; AddRange(int start, int end, IEnumerable&lt;int&gt; input) {
			var list = new List&lt;int&gt;((end - start) + 2);
			if (input != null)
				list.AddRange(input);

			for (int i = start; i &lt;= end; ++i) {
				list.Add(i);
			}

			return list;
		}

		private IEnumerable&lt;int&gt; AddRange(IndexRange range, IEnumerable&lt;int&gt; list) {
			// Select the range specified.
			var startFlag = range.StartOffset;
			var start = range.StartValue;
			var endFlag = range.EndOffset;
			var end = range.EndValue;

			int r1 = PositionOfRangePoint(startFlag, start);
			int r2 = PositionOfRangePoint(endFlag, end);

			if (r2 &lt; r1)
				return list;

			// Add the range to the set
			return AddRange(r1, r2, list);

		}

		public override IEnumerable&lt;int&gt; SelectAll() {
			return AddRange(0, Count - 1, null);
		}

		public override IEnumerable&lt;int&gt; SelectRange(IndexRange[] ranges) {
			// If no items in the set return an empty set
			if (Count == 0)
				return new List&lt;int&gt;(0);

			IEnumerable&lt;int&gt; list = null;
			foreach (var range in ranges) {
				list = AddRange(range, list);
			}

			if (list == null)
				return new List&lt;int&gt;(0);

			return list;
		}

		private int PositionOfRangePoint(RangeFieldOffset position, DataObject val) {
			int p;
			DataObject cell;

			switch (position) {

				case RangeFieldOffset.FirstValue:
					if (val.Equals(IndexRange.FirstInSet)) {
						return 0;
					}
					if (val.Equals(IndexRange.LastInSet)) {
						// Get the last value and search for the first instance of it.
						cell = Last;
					} else {
						cell = val;
					}

					p = SearchFirst(cell);

					// (If value not found)
					if (p &lt; 0)
						return -(p + 1);

					return p;

				case RangeFieldOffset.LastValue:
					if (val.Equals(IndexRange.LastInSet))
						return Count - 1;

					if (val.Equals(IndexRange.FirstInSet)) {
						// Get the first value.
						cell = First;
					} else {
						cell = val;
					}

					p = SearchLast(cell);

					// (If value not found)
					if (p &lt; 0) {
						return -(p + 1) - 1;
					}
					return p;

				case RangeFieldOffset.BeforeFirstValue:
					if (val.Equals(IndexRange.FirstInSet))
						return -1;

					if (val.Equals(IndexRange.LastInSet)) {
						// Get the last value and search for the first instance of it.
						cell = Last;
					} else {
						cell = val;
					}

					p = SearchFirst(cell);
					// (If value not found)
					if (p &lt; 0) {
						return -(p + 1) - 1;
					}
					return p - 1;

				case RangeFieldOffset.AfterLastValue:
					if (val.Equals(IndexRange.LastInSet)) {
						return Count;
					}
					if (val.Equals(IndexRange.FirstInSet)) {
						// Get the first value.
						cell = First;
					} else {
						cell = val;
					}
					p = SearchLast(cell);
					// (If value not found)
					if (p &lt; 0) {
						return -(p + 1);
					}
					return p + 1;

				default:
					throw new ApplicationException(&quot;Unrecognised position.&quot;);
			}

		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[30,10,30,32,0],[34,10,34,29,0],[38,10,38,37,0],[42,4,42,19,0],[43,5,43,67,0],[44,3,44,4,0],[47,4,47,24,0],[48,3,48,4,0],[51,4,51,24,0],[52,3,52,4,0],[55,3,55,4,0],[62,4,62,48,0],[63,4,63,22,0],[64,5,64,26,0],[66,9,66,23,0],[67,5,67,17,0],[66,34,66,37,0],[66,24,66,32,0],[70,4,70,16,0],[92,4,92,40,0],[119,7,119,16,0],[123,7,123,19,0],[138,7,138,24,0],[142,7,142,20,0],[156,6,156,44,0],[157,7,157,17,0],[159,6,159,43,0],[161,7,161,19,0],[163,7,163,18,0],[166,6,166,28,0],[168,6,168,16,0],[169,7,169,27,0],[171,6,171,19,0],[174,6,174,43,0],[175,7,175,20,0],[177,6,177,44,0],[179,7,179,20,0],[181,7,181,18,0],[183,6,183,27,0],[185,6,185,16,0],[186,7,186,23,0],[188,6,188,19,0],[191,6,191,63,0],[25,3,26,31,1],[27,3,27,4,1],[75,4,75,38,1],[76,4,76,33,1],[77,4,77,34,1],[78,4,78,29,1],[80,4,80,52,1],[81,4,81,48,1],[83,4,83,16,1],[84,5,84,17,1],[87,4,87,34,1],[97,4,97,19,1],[98,5,98,29,1],[100,4,100,33,1],[101,26,101,32,1],[101,13,101,22,1],[102,5,102,34,1],[101,23,101,25,1],[105,4,105,21,1],[106,5,106,29,1],[108,4,108,16,1],[115,4,115,21,1],[118,6,118,44,1],[121,6,121,43,1],[125,7,125,18,1],[128,6,128,28,1],[131,6,131,16,1],[132,7,132,23,1],[134,6,134,15,1],[137,6,137,43,1],[140,6,140,44,1],[144,7,144,18,1],[147,6,147,27,1],[150,6,150,16,1],[151,7,151,27,1],[153,6,153,15,1]]);
    </script>
  </body>
</html>