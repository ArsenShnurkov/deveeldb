<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.dbsystem\schemamanager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;

using Deveel.Data.Sql;
using Deveel.Data.Transactions;
using Deveel.Data.Types;

namespace Deveel.Data.DbSystem {
	public sealed class SchemaManager : IObjectManager {
		public SchemaManager(ITransaction transaction) {
			if (transaction == null)
				throw new ArgumentNullException(&quot;transaction&quot;);

			Transaction = transaction;
		}

		~SchemaManager() {
			Dispose(false);
		}

		public ITransaction Transaction { get; private set; }

		private void Dispose(bool disposing) {
			if (disposing) {
				// TODO: Additional disposals ...
			}

			Transaction = null;
		}

		public void Dispose() {
			Dispose(true);
			GC.SuppressFinalize(this);
		}

		DbObjectType IObjectManager.ObjectType {
			get { return DbObjectType.Schema; }
		}

		void IObjectManager.CreateObject(IObjectInfo objInfo) {
			var schemaInfo = objInfo as SchemaInfo;
			if (schemaInfo == null)
				throw new ArgumentException();

			CreateSchema(schemaInfo);
		}

		bool IObjectManager.RealObjectExists(ObjectName objName) {
			return SchemaExists(objName.Name);
		}

		bool IObjectManager.ObjectExists(ObjectName objName) {
			return SchemaExists(objName.Name);
		}

		IDbObject IObjectManager.GetObject(ObjectName objName) {
			return GetSchema(objName.Name);
		}

		bool IObjectManager.AlterObject(IObjectInfo objInfo) {
			throw new NotImplementedException();
		}

		bool IObjectManager.DropObject(ObjectName objName) {
			return DropSchema(objName.Name);
		}

		ObjectName IObjectManager.ResolveName(ObjectName objName, bool ignoreCase) {
			return ResolveSchemaName(objName.Name, ignoreCase);
		}

		public ObjectName ResolveSchemaName(string name, bool ignoreCase) {
			var table = Transaction.GetTable(SystemSchema.SchemaInfoTableName);

			var comparison = ignoreCase ? StringComparison.OrdinalIgnoreCase : StringComparison.Ordinal;

			foreach (var row in table) {
				var objSchemaName = row.GetValue(1);
				if (!(objSchemaName.Type is StringType))
					throw new SystemException(&quot;Invalid column type for SCHEMA name table.&quot;);
				if (objSchemaName.IsNull)
					throw new SystemException();

				var schemaName = objSchemaName.Value.ToString();
				if (String.Equals(schemaName, name, comparison))
					return new ObjectName(schemaName);
			}

			return null;
		}

		public void CreateSchema(SchemaInfo schemaInfo) {
			if (schemaInfo == null)
				throw new ArgumentNullException(&quot;schemaInfo&quot;);

			var tableName = SystemSchema.SchemaInfoTableName;
			var t = Transaction.GetMutableTable(tableName);

			var nameObj = DataObject.String(schemaInfo.Name);

			if (t.Exists(1, nameObj))
				throw new DatabaseSystemException(String.Format(&quot;Schema &#39;{0}&#39; already defined in the database.&quot;, schemaInfo.Name));

			var row = t.NewRow();
			var uniqueId = Transaction.NextTableId(tableName);
			row.SetValue(0, DataObject.Number(uniqueId));
			row.SetValue(1, DataObject.String(schemaInfo.Name));
			row.SetValue(2, DataObject.String(schemaInfo.Type));
			row.SetValue(3, DataObject.String(schemaInfo.Culture));

			t.AddRow(row);
		}

		public bool SchemaExists(string name) {
			var tableName = SystemSchema.SchemaInfoTableName;
			var t = Transaction.GetMutableTable(tableName);

			var nameObj = DataObject.String(name);

			return t.Exists(1, nameObj);
		}

		public bool DropSchema(string name) {
			var tableName = SystemSchema.SchemaInfoTableName;
			var t = Transaction.GetMutableTable(tableName);

			// Drop a single entry from dt where column 1 = name
			var nameObj = DataObject.String(name);
			return t.Delete(1, nameObj);
		}

		public Schema GetSchema(string name) {
			if (String.IsNullOrEmpty(name))
				throw new ArgumentNullException(&quot;name&quot;);

			throw new NotImplementedException();
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[27,5,27,52,0],[47,4,47,18,0],[48,4,48,30,0],[49,3,49,4,0],[58,5,58,35,0],[64,4,64,38,0],[72,4,72,35,0],[76,4,76,40,0],[80,4,80,36,0],[95,6,95,78,0],[97,6,97,34,0],[104,4,104,16,0],[109,5,109,51,0],[117,5,117,120,0],[139,4,139,53,0],[140,4,140,51,0],[143,4,143,42,0],[144,4,144,32,0],[148,4,148,35,0],[149,5,149,45,0],[151,4,151,40,0],[25,3,25,49,1],[26,4,26,28,1],[29,4,29,30,1],[30,3,30,4,1],[33,4,33,19,1],[34,3,34,4,1],[39,4,39,18,1],[43,4,43,23,1],[44,3,44,4,1],[52,10,52,37,1],[56,4,56,43,1],[57,4,57,27,1],[60,4,60,29,1],[61,3,61,4,1],[68,4,68,38,1],[84,4,84,55,1],[88,4,88,71,1],[90,4,90,96,1],[92,24,92,29,1],[92,13,92,20,1],[93,5,93,41,1],[94,5,94,45,1],[96,5,96,30,1],[99,5,99,53,1],[100,5,100,53,1],[101,6,101,40,1],[92,21,92,23,1],[105,3,105,4,1],[108,4,108,27,1],[111,4,111,53,1],[112,4,112,51,1],[114,4,114,53,1],[116,4,116,29,1],[119,4,119,25,1],[120,4,120,54,1],[121,4,121,49,1],[122,4,122,56,1],[123,4,123,56,1],[124,4,124,59,1],[126,4,126,18,1],[127,3,127,4,1],[130,4,130,53,1],[131,4,131,51,1],[133,4,133,42,1],[135,4,135,32,1]]);
    </script>
  </body>
</html>