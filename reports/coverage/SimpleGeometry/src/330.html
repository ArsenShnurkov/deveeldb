<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.transactions\transactionregistry.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections.Generic;
using System.Linq;

using Deveel.Data.DbSystem;
using Deveel.Data.Sql;

namespace Deveel.Data.Transactions {
	public sealed class TransactionRegistry : IDisposable {
		private List&lt;ITransactionEvent&gt; events;
		private List&lt;ObjectName&gt; objectsCreated;
		private List&lt;ObjectName&gt; objectsDropped;
		private List&lt;int&gt; touchedTables; 
 
		public TransactionRegistry(ITransaction transaction) {
			Transaction = transaction;

			events = new List&lt;ITransactionEvent&gt;();
		}

		~TransactionRegistry() {
			Dispose(false);
		}

		public ITransaction Transaction { get; private set; }

		public IEnumerable&lt;ObjectName&gt; ObjectsCreated {
			get {
				lock (this) {
					return objectsCreated == null ? new ObjectName[0] : objectsCreated.AsReadOnly().AsEnumerable();
				}
			}
		}

		public IEnumerable&lt;ObjectName&gt; ObjectsDropped {
			get {
				lock (this) {
					return objectsDropped == null ? new ObjectName[0] : objectsDropped.AsReadOnly().AsEnumerable();	
				}
			}
		}

		public IEnumerable&lt;int&gt; TouchedTables {
			get {
				lock (this) {
					return touchedTables == null ? new int[0] : touchedTables.AsReadOnly().AsEnumerable();
				}
			}
		}

		public IEnumerable&lt;int&gt; TablesCreated {
			get {
				lock (this) {
					return events.OfType&lt;TableCreatedEvent&gt;().Select(x =&gt; x.TableId);
				}
			}
		}

		//public IEnumerable&lt;int&gt; TablesChanged {
		//	get {
		//		lock (this) {
		//			return events.OfType&lt;ITableEvent&gt;()
		//				.Select(x =&gt; new {
		//					id = x.TableId,
		//					table = Transaction.GetTableManager().AccessedTables.First(y =&gt; y.TableInfo.Id == x.TableId)
		//				})
		//				.Where(x =&gt; x.table.EventRegistry.EventCount &gt; 0)
		//				.Select(x =&gt; x.id);
		//		}
		//	}
		//} 

		public IEnumerable&lt;int&gt; TablesDropped {
			get {
				lock (this) {
					return events.OfType&lt;TableDroppedEvent&gt;().Select(x =&gt; x.TableId);
				}
			}
		}

		public IEnumerable&lt;int&gt; TablesConstraintAltered {
			get {
				lock (this) {
					return events.OfType&lt;TableConstraintAlteredEvent&gt;().Select(x =&gt; x.TableId);
				}
			}
		}

		private void RegisterObjectDropped(ObjectName objName) {
			bool created = false;

			if (objectsCreated != null)
				created = objectsCreated.Remove(objName);

			// If the above operation didn&#39;t remove a table name then add to the
			// dropped database objects list.
			if (!created) {
				if (objectsDropped == null)
					objectsDropped = new List&lt;ObjectName&gt;();

				objectsDropped.Add(objName);
			}
		}

		private void RegisterObjectCreated(ObjectName objName) {
			// If this table name was dropped, then remove from the drop list
			bool dropped = false;
			if (objectsDropped != null)
				dropped = objectsDropped.Remove(objName);

			// If the above operation didn&#39;t remove a table name then add to the
			// created database objects list.
			if (!dropped) {
				if (objectsCreated == null)
					objectsCreated = new List&lt;ObjectName&gt;();

				objectsCreated.Add(objName);
			}
		}

		public void RegisterEvent(ITransactionEvent e) {
			lock (this) {
				if (e == null)
					throw new ArgumentNullException(&quot;e&quot;);

				//if (Transaction.ReadOnly())
				//	throw new InvalidOperationException(&quot;Transaction is read-only.&quot;);

				if (e is ObjectCreatedEvent) {
					var createdEvent = (ObjectCreatedEvent) e;
					RegisterObjectCreated(createdEvent.ObjectName);
				} else if (e is ObjectDroppedEvent) {
					var droppedEvent = (ObjectDroppedEvent) e;
					RegisterObjectDropped(droppedEvent.ObjectName);
				}

				if (e is ITableEvent) {
					var tableEvent = (ITableEvent) e;
					TouchTable(tableEvent.TableId);
				}

				events.Add(e);
			}
		}

		private void TouchTable(int tableId) {
			lock (this) {
				if (touchedTables == null)
					touchedTables = new List&lt;int&gt;();

				var index = touchedTables.LastIndexOf(tableId);
				if (index &gt; 0 &amp;&amp; touchedTables[index] == tableId)
					return;

				if (index &lt; 0) {
					touchedTables.Add(tableId);
				} else {
					touchedTables.Insert(index, tableId);
				}
			}
		}

		public IEnumerable&lt;ITransactionEvent&gt; GetEvents() {
			lock (this) {
				return events.AsReadOnly();
			}
		}

		public void Dispose() {
			Dispose(true);
			GC.SuppressFinalize(this);
		}

		private void Dispose(bool disposing) {
			if (disposing) {
				if (objectsCreated != null)
					objectsCreated.Clear();

				if (objectsDropped != null)
					objectsDropped.Clear();

				events.Clear();
			}

			objectsDropped = null;
			objectsCreated = null;
			events = null;
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[61,5,61,16,0],[62,6,62,92,0],[64,4,64,5,0],[106,4,106,25,0],[108,4,108,31,0],[109,5,109,46,0],[113,4,113,17,0],[114,5,114,32,0],[115,6,115,46,0],[117,5,117,33,0],[119,3,119,4,0],[125,5,125,46,0],[140,6,140,43,0],[149,6,149,48,0],[150,6,150,53,0],[180,4,180,15,0],[181,5,181,32,0],[183,3,183,4,0],[186,4,186,18,0],[187,4,187,30,0],[188,3,188,4,0],[192,5,192,32,0],[193,6,193,29,0],[195,5,195,32,0],[196,6,196,29,0],[198,5,198,20,0],[92,60,92,69,0],[100,70,100,79,0],[31,3,31,55,1],[32,4,32,30,1],[34,4,34,43,1],[35,3,35,4,1],[38,4,38,19,1],[39,3,39,4,1],[45,5,45,16,1],[46,6,46,101,1],[48,4,48,5,1],[53,5,53,16,1],[54,6,54,101,1],[56,4,56,5,1],[69,5,69,16,1],[70,6,70,60,1],[70,69,70,71,1],[72,4,72,5,1],[91,5,91,16,1],[92,6,92,60,1],[92,69,92,71,1],[94,4,94,5,1],[99,5,99,16,1],[100,6,100,70,1],[100,79,100,81,1],[102,4,102,5,1],[123,4,123,25,1],[124,4,124,31,1],[129,4,129,17,1],[130,5,130,32,1],[131,6,131,46,1],[133,5,133,33,1],[135,3,135,4,1],[138,4,138,15,1],[139,5,139,19,1],[145,5,145,33,1],[146,6,146,48,1],[147,6,147,53,1],[148,12,148,40,1],[153,5,153,26,1],[154,6,154,39,1],[155,6,155,37,1],[158,5,158,19,1],[160,3,160,4,1],[163,4,163,15,1],[164,5,164,31,1],[165,6,165,38,1],[167,5,167,52,1],[168,5,168,54,1],[169,6,169,13,1],[171,5,171,19,1],[172,6,172,33,1],[174,6,174,43,1],[177,3,177,4,1],[191,4,191,18,1],[201,4,201,26,1],[202,4,202,26,1],[203,4,203,18,1],[204,3,204,4,1],[70,60,70,69,1]]);
    </script>
  </body>
</html>