<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.store\inmemorystoragesystem.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections.Generic;

namespace Deveel.Data.Store {
	public sealed class InMemoryStorageSystem : IStoreSystem {
		private Dictionary&lt;string, InMemoryStore&gt; nameStoreMap;

		public const int DefaultStoreSize = 256*1024;

		public InMemoryStorageSystem() {
			nameStoreMap = new Dictionary&lt;string, InMemoryStore&gt;();
		}

		~InMemoryStorageSystem() {
			Dispose(false);
		}
 
		public void Dispose() {
			Dispose(true);
			GC.SuppressFinalize(this);
		}

		private void Dispose(bool disposing) {
			if (disposing) {
				if (nameStoreMap != null) {
					lock (this) {
						nameStoreMap.Clear();
					}
				}
			}

			lock (this) {
				nameStoreMap = null;
			}
		}

		public StorageType StorageType {
			get { return StorageType.Memory; }
		}

		public bool StoreExists(string name) {
			lock (this) {
				return nameStoreMap.ContainsKey(name);
			}
		}

		IStore IStoreSystem.CreateStore(string name) {
			return CreateStore(name, DefaultStoreSize);
		}

		public InMemoryStore CreateStore(string name) {
			return CreateStore(name, DefaultStoreSize);
		}

		public InMemoryStore CreateStore(string name, int hashSize) {
			if (String.IsNullOrEmpty(name))
				throw new ArgumentNullException(&quot;name&quot;);

			lock (this) {
				if (StoreExists(name))
					throw new ArgumentException(String.Format(&quot;The store {0} already exists.&quot;, name));

				var store = new InMemoryStore(name, hashSize);
				nameStoreMap[name] = store;
				return store;
			}
		}

		public InMemoryStore OpenStore(string name) {
			lock (this) {
				InMemoryStore store;
				if (!nameStoreMap.TryGetValue(name, out store))
					throw new InvalidOperationException(String.Format(&quot;Store {0} does not exist.&quot;, name));

				return store;
			}
		}

		IStore IStoreSystem.OpenStore(string name) {
			return OpenStore(name);
		}

		bool IStoreSystem.CloseStore(IStore store) {
			return CloseStore((InMemoryStore) store);
		}

		public bool CloseStore(InMemoryStore store) {
			if (!StoreExists(store.Name))
				throw new InvalidOperationException(String.Format(&quot;Store {0} does not exist&quot;, store.Name));

			return true;
		}

		bool IStoreSystem.DeleteStore(IStore store) {
			return DeleteStore((InMemoryStore) store);
		}

		public bool DeleteStore(InMemoryStore store) {
			if (store == null) 
				throw new ArgumentNullException(&quot;store&quot;);

			lock (this) {
				return nameStoreMap.Remove(store.Name);
			}
		}

		public void SetCheckPoint() {
			// Check point logging not necessary with memory store
		}

		public void Lock(string lockName) {
		}

		public void Unlock(string lockName) {
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[54,10,54,36,0],[73,5,73,45,0],[77,6,77,88,0],[89,6,89,92,0],[105,5,105,96,0],[111,4,111,46,0],[116,5,116,46,0],[26,3,26,33,1],[27,4,27,59,1],[28,3,28,4,1],[31,4,31,19,1],[32,3,32,4,1],[35,4,35,18,1],[36,4,36,30,1],[37,3,37,4,1],[40,4,40,18,1],[41,5,41,30,1],[42,6,42,17,1],[43,7,43,28,1],[48,4,48,15,1],[49,5,49,25,1],[51,3,51,4,1],[58,4,58,15,1],[59,5,59,43,1],[61,3,61,4,1],[64,4,64,47,1],[68,4,68,47,1],[72,4,72,35,1],[75,4,75,15,1],[76,5,76,27,1],[79,5,79,51,1],[80,5,80,32,1],[81,5,81,18,1],[83,3,83,4,1],[86,4,86,15,1],[88,5,88,52,1],[91,5,91,18,1],[93,3,93,4,1],[96,4,96,27,1],[100,4,100,45,1],[104,4,104,33,1],[107,4,107,16,1],[115,4,115,22,1],[118,4,118,15,1],[119,5,119,44,1],[121,3,121,4,1],[125,3,125,4,1],[128,3,128,4,1],[131,3,131,4,1]]);
    </script>
  </body>
</html>