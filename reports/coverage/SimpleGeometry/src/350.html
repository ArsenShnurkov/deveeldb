<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.util\bytebuffer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;

namespace Deveel.Data.Util {
	/// &lt;summary&gt;
	/// A wrapper for an array of &lt;see cref=&quot;byte&quot;/&gt;.
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;
	/// This provides various functions for altering the state of 
	/// the buffer.
	/// &lt;/remarks&gt;
	class ByteBuffer {
		/// &lt;summary&gt;
		/// The wrapped byte array itself.
		/// &lt;/summary&gt;
		private readonly byte[] buf;

		/// &lt;summary&gt;
		/// The current position in the array.
		/// &lt;/summary&gt;
		private int pos;

		/// &lt;summary&gt;
		/// The length of the buf array.
		/// &lt;/summary&gt;
		private readonly int length;

		/// &lt;summary&gt;
		/// Constructs the buffer.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;buf&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;offset&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;length&quot;&gt;&lt;/param&gt;
		public ByteBuffer(byte[] buf, int offset, int length) {
			this.buf = buf;
			this.length = length;
			pos = offset;
		}

		public ByteBuffer(byte[] buf)
			: this(buf, 0, buf.Length) {
		}

		/// &lt;summary&gt;
		/// Gets or sets the position in to the buffer.
		/// &lt;/summary&gt;
		public int Position {
			set { pos = value; }
			get { return pos; }
		}

		/// &lt;summary&gt;
		/// Returns the length of this buffer.
		/// &lt;/summary&gt;
		public int Length {
			get { return length; }
		}

		/// &lt;summary&gt;
		/// Writes a byte array into the buffer.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;b&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;offset&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;count&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ByteBuffer Write(byte[] b, int offset, int count) {
			Array.Copy(b, offset, buf, pos, count);
			pos += count;
			return this;
		}

		public ByteBuffer Write(byte[] b) {
			return Write(b, 0, b.Length);
		}

		/// &lt;summary&gt;
		/// Writes a ByteBuffer in to this buffer.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;buffer&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ByteBuffer Write(ByteBuffer buffer) {
			return Write(buffer.buf, buffer.pos, buffer.length);
		}

		/// &lt;summary&gt;
		/// Reads a byte array from the buffer.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;b&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;offset&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;count&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ByteBuffer Read(byte[] b, int offset, int count) {
			Array.Copy(buf, pos, b, offset, count);
			pos += count;
			return this;
		}

		/// &lt;summary&gt;
		/// Writes an integer into the buffer at the current position.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;v&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ByteBuffer WriteInteger(int v) {
			WriteInteger(v, buf, pos);
			pos += 4;
			return this;
		}

		/// &lt;summary&gt;
		/// Reads an integer from the buffer at the current position.
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public int ReadInt4() {
			int v = ReadInt4(buf, pos);
			pos += 4;
			return v;
		}

		/// &lt;summary&gt;
		/// Writes a byte into the buffer at the current position.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;v&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ByteBuffer WriteByte(byte v) {
			buf[pos] = v;
			++pos;
			return this;
		}

		/// &lt;summary&gt;
		/// Reads a byte from the buffer at the current position.
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public byte ReadByte() {
			byte b = buf[pos];
			++pos;
			return b;
		}

		/// &lt;summary&gt;
		/// Writes a short into the buffer at the current position.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;v&quot;&gt;&lt;/param&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public ByteBuffer WriteInt2(short v) {
			WriteInt2(v, buf, pos);
			pos += 2;
			return this;
		}

		/// &lt;summary&gt;
		/// Reads a short from the buffer at the current position.
		/// &lt;/summary&gt;
		/// &lt;returns&gt;&lt;/returns&gt;
		public short ReadInt2() {
			short v = ReadInt2(buf, pos);
			pos += 2;
			return v;
		}

		public static void WriteInteger(int value, byte[] arr, int offset) {
			/*
			TODO: check ...
		  arr[offset + 0] = (byte) ((value &gt;&gt;&gt; 24) &amp; 0xFF);
		  arr[offset + 1] = (byte) ((value &gt;&gt;&gt; 16) &amp; 0xFF);
		  arr[offset + 2] = (byte) ((value &gt;&gt;&gt;  8) &amp; 0xFF);
		  arr[offset + 3] = (byte) ((value &gt;&gt;&gt;  0) &amp; 0xFF);
			 */
			byte[] buff = BitConverter.GetBytes(value);
			Array.Copy(buff, 0, arr, offset, buff.Length);
		}

		public static char ReadChar(byte[] arr, int offset) {
		  int c1 = (((int) arr[offset + 0]) &amp; 0x0FF);
		  int c2 = (((int) arr[offset + 1]) &amp; 0x0FF);
		  return (char) ((c1 &lt;&lt; 8) + (c2));
			//TODO: check... return BitConverter.ToChar(arr, offset);
		}

		public static void WriteChar(char value, byte[] arr, int offset) {
		  arr[offset + 0] = (byte) (URShift(value, 8) &amp; 0x0FF);
		  arr[offset + 1] = (byte) (URShift(value, 0) &amp; 0x0FF);
			// byte[] buff = BitConverter.GetBytes(value);
			Array.Copy(arr, 0, arr, offset, 2);
		}

		public static short ReadInt2(byte[] arr, int offset) {
			/*
			TODO: check ...
		  int c1 = (((int) arr[offset + 0]) &amp; 0x0FF);
		  int c2 = (((int) arr[offset + 1]) &amp; 0x0FF);
		  return (short) ((c1 &lt;&lt; 8) + (c2));
			*/
			return BitConverter.ToInt16(arr, offset);
		}

		public static void WriteInt2(short value, byte[] arr, int offset) {
			/*
			TODO: check ...
		  arr[offset + 0] = (byte) ((value &gt;&gt;&gt; 8) &amp; 0x0FF);
		  arr[offset + 1] = (byte) ((value &gt;&gt;&gt; 0) &amp; 0x0FF);
			 */
			byte[] buff = BitConverter.GetBytes(value);
			Array.Copy(buff, 0, arr, offset, buff.Length);
		}

		public static int ReadInt4(byte[] arr, int offset) {
			/*
			TODO: check ...
		  int c1 = (((int) arr[offset + 0]) &amp; 0x0FF);
		  int c2 = (((int) arr[offset + 1]) &amp; 0x0FF);
		  int c3 = (((int) arr[offset + 2]) &amp; 0x0FF);
		  int c4 = (((int) arr[offset + 3]) &amp; 0x0FF);
		  return (c1 &lt;&lt; 24) + (c2 &lt;&lt; 16) + (c3 &lt;&lt; 8) + (c4);
			 */
			return BitConverter.ToInt32(arr, offset);
		}

		public static long ReadInt8(byte[] arr, int offset) {
			/*
			TODO: check ...
		  long c1 = (((int) arr[offset + 0]) &amp; 0x0FF);
		  long c2 = (((int) arr[offset + 1]) &amp; 0x0FF);
		  long c3 = (((int) arr[offset + 2]) &amp; 0x0FF);
		  long c4 = (((int) arr[offset + 3]) &amp; 0x0FF);
		  long c5 = (((int) arr[offset + 4]) &amp; 0x0FF);
		  long c6 = (((int) arr[offset + 5]) &amp; 0x0FF);
		  long c7 = (((int) arr[offset + 6]) &amp; 0x0FF);
		  long c8 = (((int) arr[offset + 7]) &amp; 0x0FF);
    
		  return (c1 &lt;&lt; 56) + (c2 &lt;&lt; 48) + (c3 &lt;&lt; 40) +
				 (c4 &lt;&lt; 32) + (c5 &lt;&lt; 24) + (c6 &lt;&lt; 16) + (c7 &lt;&lt;  8) + (c8);
			 */
			return BitConverter.ToInt64(arr, offset);
		}

		public static void WriteInt8(long value, byte[] arr, int offset) {
			/*
			TODO:
		  arr[offset + 0] = (byte) ((value &gt;&gt;&gt; 56) &amp; 0xFF);
		  arr[offset + 1] = (byte) ((value &gt;&gt;&gt; 48) &amp; 0xFF);
		  arr[offset + 2] = (byte) ((value &gt;&gt;&gt; 40) &amp; 0xFF);
		  arr[offset + 3] = (byte) ((value &gt;&gt;&gt; 32) &amp; 0xFF);
		  arr[offset + 4] = (byte) ((value &gt;&gt;&gt; 24) &amp; 0xFF);
		  arr[offset + 5] = (byte) ((value &gt;&gt;&gt; 16) &amp; 0xFF);
		  arr[offset + 6] = (byte) ((value &gt;&gt;&gt;  8) &amp; 0xFF);
		  arr[offset + 7] = (byte) ((value &gt;&gt;&gt;  0) &amp; 0xFF);
			*/
			byte[] buff = BitConverter.GetBytes(value);
			Array.Copy(buff, 0, arr, offset, buff.Length);
		}

		/// &lt;summary&gt;
		/// Operates a shift on the given integer by the number of bits specified.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;number&quot;&gt;The number to shift.&lt;/param&gt;
		/// &lt;param name=&quot;bits&quot;&gt;The number of bits to shift the given number.&lt;/param&gt;
		/// &lt;returns&gt;
		/// Returns an &lt;see cref=&quot;Deveel.Data.DbSystem.Int32&quot;&gt;int&lt;/see&gt; representing the shifted
		/// number.
		/// &lt;/returns&gt;
		public static int URShift(int number, int bits) {
			if (number &gt;= 0)
				return number &gt;&gt; bits;
			return (number &gt;&gt; bits) + (2 &lt;&lt; ~bits);
		}

		public static int URShift(int number, long bits) {
			return URShift(number, (int)bits);
		}

		public static long URShift(long number, int bits) {
			if (number &gt;= 0)
				return number &gt;&gt; bits;
			return (number &gt;&gt; bits) + (2L &lt;&lt; ~bits);
		}

		public static long URShift(long number, long bits) {
			return URShift(number, (int)bits);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[49,3,49,56,0],[50,4,50,19,0],[51,4,51,25,0],[52,4,52,17,0],[53,3,53,4,0],[55,3,56,30,0],[57,3,57,4,0],[63,10,63,22,0],[63,23,63,24,0],[64,10,64,21,0],[71,10,71,24,0],[82,4,82,43,0],[83,4,83,17,0],[84,4,84,16,0],[88,4,88,33,0],[97,4,97,56,0],[108,4,108,43,0],[109,4,109,17,0],[110,4,110,16,0],[119,4,119,30,0],[120,4,120,13,0],[121,4,121,16,0],[129,4,129,31,0],[130,4,130,13,0],[131,4,131,13,0],[140,4,140,17,0],[141,4,141,10,0],[142,4,142,16,0],[150,4,150,22,0],[151,4,151,10,0],[152,4,152,13,0],[161,4,161,27,0],[162,4,162,13,0],[163,4,163,16,0],[171,4,171,33,0],[172,4,172,13,0],[173,4,173,13,0],[184,4,184,47,0],[185,4,185,50,0],[186,3,186,4,0],[189,5,189,48,0],[190,5,190,48,0],[191,5,191,38,0],[196,5,196,58,0],[197,5,197,58,0],[199,4,199,39,0],[200,3,200,4,0],[209,4,209,45,0],[218,4,218,47,0],[219,4,219,50,0],[220,3,220,4,0],[231,4,231,45,0],[249,4,249,45,0],[264,4,264,47,0],[265,4,265,50,0],[266,3,266,4,0],[280,4,280,43,0],[284,4,284,38,0],[288,4,288,20,0],[289,5,289,27,0],[290,4,290,44,0],[294,4,294,38,0],[278,4,278,20,1],[279,5,279,27,1]]);
    </script>
  </body>
</html>