<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.transactions\transactionextensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;

using Deveel.Data.DbSystem;
using Deveel.Data.Index;
using Deveel.Data.Sql;
using Deveel.Data.Sql.Objects;
using Deveel.Data.Sql.Query;
using Deveel.Data.Types;

namespace Deveel.Data.Transactions {
	/// &lt;summary&gt;
	/// Provides some convenience extension methods to &lt;see cref=&quot;ITransaction&quot;/&gt; instances.
	/// &lt;/summary&gt;
	public static class TransactionExtensions {
		#region Managers

		public static TableManager GetTableManager(this ITransaction transaction) {
			return (TableManager) transaction.ObjectManagerResolver.ResolveForType(DbObjectType.Table);
		}

		public static ViewManager GetViewManager(this ITransaction transaction) {
			return (ViewManager) transaction.ObjectManagerResolver.ResolveForType(DbObjectType.View);
		}

		#endregion

		#region Objects

		public static IDbObject FindObject(this ITransaction transaction, ObjectName objName) {
			return transaction.ObjectManagerResolver.GetManagers()
				.Select(manager =&gt; manager.GetObject(objName))
				.FirstOrDefault(obj =&gt; obj != null);
		}

		public static IDbObject GetObject(this ITransaction transaction, DbObjectType objType, ObjectName objName) {
			var manager = transaction.ObjectManagerResolver.ResolveForType(objType);
			if (manager == null)
				return null;

			return manager.GetObject(objName);
		}

		public static bool ObjectExists(this ITransaction transaction, ObjectName objName) {
			return transaction.ObjectManagerResolver.GetManagers()
				.Any(manager =&gt; manager.ObjectExists(objName));
		}

		public static bool ObjectExists(this ITransaction transaction, DbObjectType objType, ObjectName objName) {
			var manager = transaction.ObjectManagerResolver.ResolveForType(objType);
			if (manager == null)
				return false;

			return manager.ObjectExists(objName);
		}

		public static bool RealObjectExists(this ITransaction transaction, DbObjectType objType, ObjectName objName) {
			var manager = transaction.ObjectManagerResolver.ResolveForType(objType);
			if (manager == null)
				return false;

			return manager.RealObjectExists(objName);			
		}

		public static void CreateObject(this ITransaction transaction, IObjectInfo objInfo) {
			if (objInfo == null)
				throw new ArgumentNullException(&quot;objInfo&quot;);

			var manager = transaction.ObjectManagerResolver.ResolveForType(objInfo.ObjectType);
			if (manager == null)
				throw new InvalidOperationException();

			if (manager.ObjectType != objInfo.ObjectType)
				throw new ArgumentException();

			manager.CreateObject(objInfo);
		}

		public static bool AlterObject(this ITransaction transaction, IObjectInfo objInfo) {
			if (objInfo == null)
				throw new ArgumentNullException(&quot;objInfo&quot;);

			var manager = transaction.ObjectManagerResolver.ResolveForType(objInfo.ObjectType);
			if (manager == null)
				throw new InvalidOperationException();

			if (manager.ObjectType != objInfo.ObjectType)
				throw new ArgumentException();

			return manager.AlterObject(objInfo);
		}

		public static bool DropObject(this ITransaction transaction, DbObjectType objType, ObjectName objName) {
			var manager = transaction.ObjectManagerResolver.ResolveForType(objType);
			if (manager == null)
				return false;

			return manager.DropObject(objName);
		}

		public static ObjectName ResolveObjectName(this ITransaction transaction, string schemaName, string objectName) {
			if (String.IsNullOrEmpty(objectName))
				throw new ArgumentNullException(&quot;objectName&quot;);

			if (String.IsNullOrEmpty(schemaName))
				schemaName = transaction.CurrentSchema();

			var objName = new ObjectName(new ObjectName(schemaName), objectName);

			// Special case for OLD and NEW tables
			if (String.Compare(objectName, &quot;OLD&quot;, StringComparison.OrdinalIgnoreCase) == 0)
				return SystemSchema.OldTriggerTableName;
			if (String.Compare(objectName, &quot;NEW&quot;, StringComparison.OrdinalIgnoreCase) == 0)
				return SystemSchema.NewTriggerTableName;

			bool found = false;

			foreach (var manager in transaction.ObjectManagerResolver.GetManagers()) {
				if (manager.ObjectExists(objName)) {
					if (found)
						throw new ArgumentException(String.Format(&quot;The name &#39;{0}&#39; is an ambiguous match.&quot;, objectName));
 
					found = true;
				}
			}

			if (!found)
				throw new ObjectNotFoundException(objectName);

			return objName;
		}

		public static ObjectName ResolveObjectName(this ITransaction transaction, string objectName) {
			return transaction.ResolveObjectName(transaction.CurrentSchema(), objectName);
		}

		public static ObjectName ResolveObjectName(this ITransaction transaction, DbObjectType objectType, ObjectName objectName) {
			var manager = transaction.ObjectManagerResolver.ResolveForType(objectType);
			if (manager == null)
				return objectName;

			return manager.ResolveName(objectName, transaction.IgnoreIdentifiersCase());
		}

		public static ObjectName ResolveObjectName(this ITransaction transaction, ObjectName objectName) {
			var ignoreCase = transaction.IgnoreIdentifiersCase();

			return transaction.ObjectManagerResolver.GetManagers()
				.Select(manager =&gt; manager.ResolveName(objectName, ignoreCase))
				.FirstOrDefault(resolved =&gt; resolved != null);
		}

		#endregion

		#region Schema

		public static void CreateSchema(this ITransaction transaction, SchemaInfo schemaInfo) {
			transaction.CreateObject(schemaInfo);
		}

		public static void CreateSystemSchema(this ITransaction transaction) {
			SystemSchema.CreateSystemTables(transaction);

			// TODO: get the configured default culture...
			var culture = CultureInfo.CurrentCulture.Name;
			var schemaInfo = new SchemaInfo(SystemSchema.Name, SchemaTypes.System);
			schemaInfo.Culture = culture;

			transaction.CreateSchema(schemaInfo);
		}

		public static void DropSchema(this ITransaction transaction, string schemaName) {
			transaction.DropObject(DbObjectType.Schema, new ObjectName(schemaName));
		}

		public static Schema GetSchema(this ITransaction transaction, string schemaName) {
			var obj = transaction.GetObject(DbObjectType.Schema, new ObjectName(schemaName));
			if (obj == null)
				return null;

			return (Schema) obj;
		}

		public static bool SchemaExists(this ITransaction transaction, string schemaName) {
			return transaction.ObjectExists(DbObjectType.Schema, new ObjectName(schemaName));
		}

		#endregion

		#region Tables

		public static ObjectName ResolveReservedTableName(this ITransaction transaction, ObjectName tableName) {
			// We do not allow tables to be created with a reserved name
			var name = tableName.Name;

			if (String.Compare(name, &quot;OLD&quot;, StringComparison.OrdinalIgnoreCase) == 0)
				return SystemSchema.OldTriggerTableName;
			if (String.Compare(name, &quot;NEW&quot;, StringComparison.OrdinalIgnoreCase) == 0)
				return SystemSchema.NewTriggerTableName;

			return tableName;
		}

		public static ObjectName ResolveTableName(this ITransaction transaction, ObjectName tableName) {
			if (tableName == null)
				return null;

			if (tableName.Parent == null)
				tableName = new ObjectName(new ObjectName(transaction.CurrentSchema()), tableName.Name);

			// We do not allow tables to be created with a reserved name
			var name = tableName.Name;

			if (String.Compare(name, &quot;OLD&quot;, StringComparison.OrdinalIgnoreCase) == 0)
				return SystemSchema.OldTriggerTableName;
			if (String.Compare(name, &quot;NEW&quot;, StringComparison.OrdinalIgnoreCase) == 0)
				return SystemSchema.NewTriggerTableName;

			return transaction.ResolveObjectName(DbObjectType.Table, tableName);
		}

		public static bool TableExists(this ITransaction transaction, ObjectName tableName) {
			return transaction.ObjectExists(DbObjectType.Table, transaction.ResolveReservedTableName(tableName));
		}

		public static bool RealTableExists(this ITransaction transaction, ObjectName objName) {
			return transaction.RealObjectExists(DbObjectType.Table, objName);
		}

		/// &lt;summary&gt;
		/// Tries to get an object with the given name formed as table.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;transaction&quot;&gt;The transaction object.&lt;/param&gt;
		/// &lt;param name=&quot;tableName&quot;&gt;The name of the table to try to get.&lt;/param&gt;
		/// &lt;returns&gt;
		/// Returns an instance of &lt;see cref=&quot;ITable&quot;/&gt; if an object with the given name was
		/// found in the underlying transaction and it is of &lt;see cref=&quot;DbObjectType.Table&quot;/&gt; and
		/// it is &lt;c&gt;not null&lt;/c&gt;.
		/// &lt;/returns&gt;
		public static ITable GetTable(this ITransaction transaction, ObjectName tableName) {
			tableName = transaction.ResolveReservedTableName(tableName);
			if (tableName.Equals(SystemSchema.OldTriggerTableName, transaction.IgnoreIdentifiersCase()))
				return transaction.OldNewTableState.OldDataTable;
			if (tableName.Equals(SystemSchema.NewTriggerTableName, transaction.IgnoreIdentifiersCase()))
				return transaction.OldNewTableState.NewDataTable;

			var table = (ITable) transaction.GetObject(DbObjectType.Table, tableName);
			if (table != null) {
				//table = new DataTable(transaction, table);
				// TODO: encapsulate this into a table object that catches and fires events
			}

			return table;
		}

		internal static IEnumerable&lt;TableSource&gt; GetVisibleTables(this ITransaction transaction) {
			return transaction.GetTableManager().GetVisibleTables();
		}

		internal static void RemoveVisibleTable(this ITransaction transaction, TableSource table) {
			transaction.GetTableManager().RemoveVisibleTable(table);
		}

		internal static void UpdateVisibleTable(this ITransaction transaction, TableSource tableSource, IIndexSet indexSet) {
			transaction.GetTableManager().UpdateVisibleTable(tableSource, indexSet);
		}

		internal static IIndexSet GetIndexSetForTable(this ITransaction transaction, TableSource tableSource) {
			return transaction.GetTableManager().GetIndexSetForTable(tableSource);
		}

		public static IMutableTable GetMutableTable(this ITransaction transaction, ObjectName tableName) {
			return transaction.GetTable(tableName) as IMutableTable;
		}

		public static TableInfo GetTableInfo(this ITransaction transaction, ObjectName tableName) {
			var tableManager = transaction.ObjectManagerResolver.ResolveForType(DbObjectType.Table) as TableManager;
			if (tableManager == null)
				throw new SystemException();

			return tableManager.GetTableInfo(tableName);
		}

		public static string GetTableType(this ITransaction transaction, ObjectName tableName) {
			var tableManager = transaction.GetTableManager();
			if (tableManager == null)
				throw new SystemException();

			return tableManager.GetTableType(tableName);
		}

		public static void CreateTable(this ITransaction transaction, TableInfo tableInfo) {
			CreateTable(transaction, tableInfo, false);
		}

		public static void CreateTable(this ITransaction transaction, TableInfo tableInfo, bool temporary) {
			var tableManager = transaction.GetTableManager();
			if (temporary) {
				tableManager.CreateTemporaryTable(tableInfo);
			} else {
				tableManager.CreateTable(tableInfo);
			}
		}

		/// &lt;summary&gt;
		/// Alters the table with the given name within this transaction to the
		/// specified table definition.
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;transaction&quot;&gt;&lt;/param&gt;
		/// &lt;param name=&quot;tableInfo&quot;&gt;&lt;/param&gt;
		/// &lt;remarks&gt;
		/// This should only be called under an exclusive lock on the connection.
		/// &lt;/remarks&gt;
		/// &lt;exception cref=&quot;StatementException&quot;&gt;
		/// If the table does not exist.
		/// &lt;/exception&gt;
		public static void AlterTable(this ITransaction transaction, TableInfo tableInfo) {
			transaction.AlterObject(tableInfo);
		}

		public static bool DropTable(this ITransaction transaction, ObjectName tableName) {
			return transaction.DropObject(DbObjectType.Table, tableName);
		}

		#endregion

		#region Views

		public static void DefineView(this ITransaction transaction, ViewInfo viewInfo) {
			transaction.CreateObject(viewInfo);
		}

		public static IQueryPlanNode GetViewQueryPlan(this ITransaction transaction, ObjectName viewName) {
			var view = transaction.GetViewManager().GetView(viewName);
			if (view == null)
				return null;

			return view.QueryPlan;
		}

		#endregion

		#region Sequences

		public static void CreateSequence(this ITransaction transaction, SequenceInfo sequenceInfo) {
			transaction.CreateObject(sequenceInfo);
		}

		public static void CreateNativeSequence(this ITransaction transaction, ObjectName tableName) {
			var seqInfo = new SequenceInfo(tableName);
			transaction.CreateSequence(seqInfo);
		}

		public static void RemoveNativeSequence(this ITransaction transaction, ObjectName tableName) {
			transaction.DropSequence(tableName);
		}

		public static bool DropSequence(this ITransaction transaction, ObjectName sequenceName) {
			return transaction.DropObject(DbObjectType.Sequence, sequenceName);
		}

		public static ISequence GetSequence(this ITransaction transaction, ObjectName sequenceName) {
			return transaction.GetObject(DbObjectType.Sequence, sequenceName) as ISequence;
		}

		public static SqlNumber NextValue(this ITransaction transaction, ObjectName sequenceName) {
			var sequence = transaction.GetSequence(sequenceName);
			if (sequence == null)
				throw new ObjectNotFoundException(sequenceName);

			return sequence.NextValue();
		}

		public static SqlNumber LastValue(this ITransaction transaction, ObjectName sequenceName) {
			var sequence = transaction.GetSequence(sequenceName);
			if (sequence == null)
				throw new ObjectNotFoundException(sequenceName);

			return sequence.GetCurrentValue();
		}

		public static SqlNumber SetValue(this ITransaction transaction, ObjectName sequenceName, SqlNumber value) {
			var sequence = transaction.GetSequence(sequenceName);
			if (sequence == null)
				throw new ObjectNotFoundException(sequenceName);

			return sequence.SetValue(value);
		}

		#endregion

		#region Variables

		public static Variable GetVariable(this ITransaction transaction, string name) {
			return transaction.GetObject(DbObjectType.Variable, new ObjectName(name)) as Variable;
		}

		public static void SetVariable(this ITransaction transaction, string name, DataObject value) {
			var variable = transaction.GetVariable(name);
			if (variable == null)
				variable = transaction.DefineVariable(name, value.Type);

			variable.SetValue(value);
		}

		public static void SetBooleanVariable(this ITransaction transaction, string name, bool value) {
			transaction.SetVariable(name, DataObject.Boolean(value));
		}

		public static void SetStringVariable(this ITransaction transaction, string name, string value) {
			transaction.SetVariable(name, DataObject.String(value));
		}

		public static Variable DefineVariable(this ITransaction transaction, string name, DataType type) {
			var variableInfo = new VariableInfo(name, type, false);
			transaction.CreateObject(variableInfo);
			return transaction.GetVariable(name);
		}

		public static bool GetBooleanVariable(this ITransaction transaction, string name) {
			var variable = transaction.GetVariable(name);
			if (variable == null)
				return false;

			return variable.Value.AsBoolean();
		}

		public static string GetStringVariable(this ITransaction transaction, string name) {
			var variable = transaction.GetVariable(name);
			if (variable == null)
				return null;

			return variable.Value;
		}

		public static bool IgnoreIdentifiersCase(this ITransaction transaction) {
			return transaction.GetBooleanVariable(TransactionSettingKeys.IgnoreIdentifiersCase);
		}

		public static void IgnoreIdentifiersCase(this ITransaction transaction, bool value) {
			transaction.SetBooleanVariable(TransactionSettingKeys.IgnoreIdentifiersCase, value);
		}

		public static bool ReadOnly(this ITransaction transaction) {
			return transaction.GetBooleanVariable(TransactionSettingKeys.ReadOnly);
		}

		public static void ReadOnly(this ITransaction transaction, bool value) {
			transaction.SetBooleanVariable(TransactionSettingKeys.ReadOnly, value);
		}

		public static bool AutoCommit(this ITransaction transaction) {
			return transaction.GetBooleanVariable(TransactionSettingKeys.AutoCommit);
		}

		public static void AutoCommit(this ITransaction transaction, bool value) {
			transaction.SetBooleanVariable(TransactionSettingKeys.AutoCommit, value);
		}

		public static void CurrentSchema(this ITransaction transaction, string schemaName) {
			transaction.SetStringVariable(TransactionSettingKeys.CurrentSchema, schemaName);
		}

		public static string CurrentSchema(this ITransaction transaction) {
			return transaction.GetStringVariable(TransactionSettingKeys.CurrentSchema);
		}

		public static bool ErrorOnDirtySelect(this ITransaction transaction) {
			return transaction.GetBooleanVariable(TransactionSettingKeys.ErrorOnDirtySelect);
		}

		#endregion

		#region Locks

		public static LockHandle LockRead(this ITransaction transaction, IEnumerable&lt;ObjectName&gt; tableNames, LockingMode mode) {
			var tables = tableNames.Select(transaction.GetTable).OfType&lt;ILockable&gt;();
			return transaction.Database.Context.Locker.Lock(new ILockable[0], tables.ToArray(), mode);
		}

		public static LockHandle LockWrite(this ITransaction transaction, IEnumerable&lt;ObjectName&gt; tableNames, LockingMode mode) {
			var tables = tableNames.Select(transaction.GetTable).OfType&lt;ILockable&gt;().ToArray();
			return transaction.Database.Context.Locker.Lock(tables, new ILockable[0], mode);
		}

		public static bool IsTableLocked(this ITransaction transaction, ITable table) {
			var lockable = table as ILockable;
			if (lockable == null)
				return false;

			return transaction.Database.Context.Locker.IsLocked(lockable);
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[41,4,41,93,0],[49,4,50,24,0],[51,39,51,41,0],[57,5,57,17,0],[63,4,64,21,0],[64,50,64,52,0],[70,5,70,18,0],[78,5,78,18,0],[85,5,85,48,0],[89,5,89,43,0],[92,5,92,35,0],[98,4,98,24,0],[99,5,99,48,0],[101,4,101,87,0],[102,4,102,24,0],[103,5,103,43,0],[105,4,105,49,0],[106,5,106,35,0],[108,4,108,40,0],[112,4,112,76,0],[113,4,113,24,0],[114,5,114,18,0],[116,4,116,39,0],[120,4,120,41,0],[121,5,121,51,0],[123,4,123,41,0],[124,5,124,46,0],[126,4,126,73,0],[129,4,129,83,0],[130,5,130,45,0],[131,4,131,83,0],[132,5,132,45,0],[134,4,134,23,0],[136,28,136,75,0],[136,13,136,24,0],[137,5,137,39,0],[138,6,138,16,0],[139,7,139,103,0],[141,6,141,19,0],[136,25,136,27,0],[145,4,145,15,0],[146,5,146,51,0],[148,4,148,19,0],[152,4,152,82,0],[158,5,158,23,0],[164,4,164,57,0],[166,4,167,24,0],[168,49,168,51,0],[191,4,191,76,0],[192,3,192,4,0],[195,4,195,85,0],[196,4,196,20,0],[197,5,197,17,0],[199,4,199,24,0],[203,4,203,85,0],[215,5,215,45,0],[217,5,217,45,0],[224,5,224,17,0],[233,5,233,45,0],[235,5,235,45,0],[261,5,261,54,0],[263,5,263,54,0],[275,4,275,60,0],[279,4,279,60,0],[280,3,280,4,0],[297,5,297,33,0],[305,5,305,33,0],[317,5,317,50,0],[336,4,336,39,0],[337,3,337,4,0],[340,4,340,65,0],[348,4,348,39,0],[349,3,349,4,0],[352,4,352,62,0],[353,4,353,21,0],[354,5,354,17,0],[356,4,356,26,0],[373,4,373,40,0],[374,3,374,4,0],[377,4,377,71,0],[381,4,381,83,0],[385,4,385,57,0],[386,4,386,25,0],[387,5,387,53,0],[389,4,389,32,0],[393,4,393,57,0],[394,4,394,25,0],[395,5,395,53,0],[397,4,397,38,0],[401,4,401,57,0],[402,4,402,25,0],[403,5,403,53,0],[405,4,405,36,0],[419,5,419,61,0],[433,4,433,59,0],[434,4,434,43,0],[435,4,435,41,0],[449,5,449,17,0],[459,4,459,88,0],[460,3,460,4,0],[471,4,471,77,0],[495,4,495,77,0],[496,4,496,94,0],[500,4,500,87,0],[501,4,501,84,0],[505,4,505,38,0],[506,4,506,25,0],[507,5,507,18,0],[509,4,509,66,0],[51,28,51,39,0],[168,33,168,49,0],[50,24,50,50,0],[64,21,64,50,0],[167,24,167,67,0],[37,4,37,95,1],[55,4,55,76,1],[56,4,56,24,1],[59,4,59,38,1],[68,4,68,76,1],[69,4,69,24,1],[72,4,72,41,1],[76,4,76,76,1],[77,4,77,24,1],[80,4,80,45,1],[84,4,84,24,1],[87,4,87,87,1],[88,4,88,24,1],[91,4,91,49,1],[94,4,94,34,1],[95,3,95,4,1],[156,4,156,79,1],[157,4,157,24,1],[160,4,160,80,1],[176,4,176,41,1],[177,3,177,4,1],[180,4,180,49,1],[183,4,183,50,1],[184,4,184,75,1],[185,4,185,33,1],[187,4,187,41,1],[188,3,188,4,1],[212,4,212,30,1],[214,4,214,77,1],[216,4,216,77,1],[219,4,219,21,1],[223,4,223,26,1],[226,4,226,33,1],[227,5,227,93,1],[230,4,230,30,1],[232,4,232,77,1],[234,4,234,77,1],[237,4,237,72,1],[241,4,241,105,1],[245,4,245,69,1],[259,4,259,64,1],[260,4,260,96,1],[262,4,262,96,1],[265,4,265,78,1],[266,4,266,22,1],[271,4,271,17,1],[283,4,283,76,1],[284,3,284,4,1],[287,4,287,74,1],[291,4,291,60,1],[295,4,295,108,1],[296,4,296,29,1],[299,4,299,48,1],[303,4,303,53,1],[304,4,304,29,1],[307,4,307,48,1],[311,4,311,47,1],[312,3,312,4,1],[315,4,315,53,1],[316,4,316,18,1],[319,5,319,41,1],[321,3,321,4,1],[364,4,364,43,1],[365,3,365,4,1],[368,4,368,46,1],[369,4,369,40,1],[370,3,370,4,1],[413,4,413,90,1],[417,4,417,49,1],[418,4,418,25,1],[421,4,421,29,1],[422,3,422,4,1],[425,4,425,61,1],[426,3,426,4,1],[429,4,429,60,1],[430,3,430,4,1],[439,4,439,49,1],[440,4,440,25,1],[441,5,441,18,1],[443,4,443,38,1],[447,4,447,49,1],[448,4,448,25,1],[451,4,451,26,1],[455,4,455,88,1],[463,4,463,75,1],[467,4,467,75,1],[468,3,468,4,1],[475,4,475,77,1],[476,3,476,4,1],[479,4,479,84,1],[480,3,480,4,1],[483,4,483,79,1],[487,4,487,85,1]]);
    </script>
  </body>
</html>