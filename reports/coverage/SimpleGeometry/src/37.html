<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.configuration\propertiesconfigformatter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections;
using System.Collections.Generic;
using System.Globalization;
using System.IO;

using Deveel.Data.Util;

namespace Deveel.Data.Configuration {
	public sealed class PropertiesConfigFormatter : IConfigFormatter {
		private void SetValue(IDbConfig config, string propKey, string value) {
			var configKey = config.GetKey(propKey);
			if (configKey != null) {
				var propValue = ConvertValueTo(value, configKey.ValueType);
				config.SetValue(configKey, propValue);
			} else {
				configKey = new ConfigKey(propKey, typeof (string));
				config.SetKey(configKey);
				config.SetValue(configKey, value);
			}
		}

		private object ConvertValueTo(string value, Type valueType) {
			return Convert.ChangeType(value, valueType, CultureInfo.InvariantCulture);
		}

		public void LoadInto(IDbConfig config, Stream inputStream) {
			if (inputStream == null)
				throw new ArgumentNullException(&quot;inputStream&quot;);

			try {
				var properties = new Properties();
				properties.Load(inputStream);

				foreach (DictionaryEntry entry in properties) {
					var propKey = (string) entry.Key;
					SetValue(config, propKey, (string) entry.Value);
				}
			} catch (DatabaseConfigurationException) {
				throw;
			} catch (Exception ex) {
				throw new DatabaseConfigurationException(&quot;Could not load properties from the given stream.&quot;, ex);
			}
		}

		public void SaveFrom(IDbConfig config, ConfigurationLevel level, Stream outputStream) {
			try {
				var keys = config.GetKeys(level);
				var properties = new Properties();

				foreach (var configKey in keys) {
					var configValue = config.GetValue(configKey);
					object value;
					if (configValue == null || configValue.Value == null) {
						value = configKey.DefaultValue;
					} else {
						value = configValue.Value;
					}

					var stringValue = Convert.ToString(value, CultureInfo.InvariantCulture);
					properties.SetProperty(configKey.Name, stringValue);
				}

				properties.Store(outputStream, String.Empty);
			} catch (DatabaseConfigurationException) {
				throw;
			} catch (Exception ex) {
				throw new DatabaseConfigurationException(&quot;Could not save the configurations to the given stream.&quot;, ex);
			}
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[45,5,45,52,0],[55,6,55,44,0],[56,5,56,11,0],[57,6,57,26,0],[58,5,58,102,0],[64,5,64,38,0],[65,5,65,39,0],[67,31,67,35,0],[67,14,67,27,0],[68,6,68,51,0],[70,6,70,59,0],[71,7,71,38,0],[73,7,73,33,0],[76,6,76,78,0],[77,6,77,58,0],[67,28,67,30,0],[80,5,80,50,0],[81,6,81,44,0],[82,5,82,11,0],[83,6,83,26,0],[84,5,84,108,0],[86,3,86,4,0],[28,4,28,43,1],[29,4,29,26,1],[30,5,30,64,1],[31,5,31,43,1],[33,5,33,57,1],[34,5,34,30,1],[35,5,35,39,1],[37,3,37,4,1],[40,4,40,78,1],[44,4,44,28,1],[48,5,48,39,1],[49,5,49,34,1],[51,39,51,49,1],[51,14,51,35,1],[52,6,52,39,1],[53,6,53,54,1],[51,36,51,38,1],[60,3,60,4,1]]);
    </script>
  </body>
</html>