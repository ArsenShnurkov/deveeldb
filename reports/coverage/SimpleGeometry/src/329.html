<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.transactions\transactioncollection.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;

using Deveel.Data.DbSystem;

namespace Deveel.Data.Transactions {
	public sealed class TransactionCollection : IEnumerable&lt;ITransaction&gt; {
		private readonly List&lt;ITransaction&gt; transactions;
		private long minCommitId;
		private long maxCommitId;
 
		public TransactionCollection(ITransactionContext transactionContext) {
			if (transactionContext == null)
				throw new ArgumentNullException(&quot;transactionContext&quot;);

			TransactionContext = transactionContext;

			transactions = new List&lt;ITransaction&gt;();
			minCommitId = Int64.MaxValue;
			maxCommitId = 0;
		}

		public ITransactionContext TransactionContext { get; private set; }

		public int Count {
			get {
				lock (this) {
					return transactions.Count;
				}
			}
		}

		public void AddTransaction(ITransaction transaction) {
			lock (this) {
				long currentCommitId = transaction.CommitId;
				if (currentCommitId &lt; maxCommitId)
					throw new ApplicationException(&quot;Added a transaction with a lower than maximum commit id&quot;);
				
				transactions.Add(transaction);
				//TODO: SystemContext.Stats.Increment(StatsDefaultKeys.OpenTransactionsCount);
				maxCommitId = currentCommitId;
			}
		}

		public void RemoveTransaction(ITransaction transaction) {
			lock (this) {
				int size = transactions.Count;
				int i = transactions.IndexOf(transaction);
				if (i == 0) {
					// First in list.
					if (i == size - 1) {
						// And last.
						minCommitId = Int32.MaxValue;
						maxCommitId = 0;
					} else {
						minCommitId = transactions[i + 1].CommitId;
					}
				} else if (i == transactions.Count - 1) {
					// Last in list.
					maxCommitId = transactions[i - 1].CommitId;
				} else if (i == -1) {
					throw new ApplicationException(&quot;Unable to find transaction in the list.&quot;);
				}

				transactions.RemoveAt(i);
				//TODO: SystemContext.Stats.Decrement(StatsDefaultKeys.OpenTransactionsCount);
			}
		}

		public long MinimumCommitId(ITransaction transaction) {
			lock (this) {
				long commitId = Int64.MaxValue;
				if (transactions.Count &gt; 0) {
					// If the bottom transaction is this transaction, then go to the
					// next up from the bottom (we don&#39;t count this transaction as the
					// minimum commit_id).
					var testTransaction = transactions[0];
					if (testTransaction != transaction) {
						commitId = testTransaction.CommitId;
					} else if (transactions.Count &gt; 1) {
						commitId = transactions[1].CommitId;
					}
				}

				return commitId;
			}
		}

		public IEnumerator&lt;ITransaction&gt; GetEnumerator() {
			lock (this) {
				return transactions.GetEnumerator();
			}
		}

		IEnumerator IEnumerable.GetEnumerator() {
			return GetEnumerator();
		}

		public ITransaction FindById(int commitId) {
			lock (this) {
				return transactions.FirstOrDefault(x =&gt; x.CommitId == commitId);
			}
		}
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[32,5,32,59,0],[55,6,55,96,0],[74,7,74,50,0],[79,12,79,24,0],[80,6,80,80,0],[95,6,95,44,0],[96,6,96,41,0],[97,7,97,43,0],[98,13,98,40,0],[99,7,99,43,0],[108,4,108,15,0],[109,5,109,41,0],[111,3,111,4,0],[114,4,114,27,0],[118,4,118,15,0],[119,5,119,45,0],[119,67,119,69,0],[121,3,121,4,0],[119,45,119,67,0],[30,3,30,71,1],[31,4,31,35,1],[34,4,34,44,1],[36,4,36,44,1],[37,4,37,33,1],[38,4,38,20,1],[39,3,39,4,1],[45,5,45,16,1],[46,6,46,32,1],[48,4,48,5,1],[52,4,52,15,1],[53,5,53,49,1],[54,5,54,39,1],[57,5,57,35,1],[59,5,59,35,1],[61,3,61,4,1],[64,4,64,15,1],[65,5,65,35,1],[66,5,66,47,1],[67,5,67,16,1],[69,6,69,24,1],[71,7,71,36,1],[72,7,72,23,1],[76,12,76,44,1],[78,6,78,49,1],[83,5,83,30,1],[86,3,86,4,1],[89,4,89,15,1],[90,5,90,36,1],[91,5,91,32,1],[103,5,103,21,1],[105,3,105,4,1]]);
    </script>
  </body>
</html>