<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.sql.statements\createviewstatement.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;

using Deveel.Data.DbSystem;
using Deveel.Data.Sql.Expressions;
using Deveel.Data.Sql.Query;

namespace Deveel.Data.Sql.Statements {
	[Serializable]
	public sealed class CreateViewStatement : SqlStatement {
		public CreateViewStatement(ObjectName viewName, SqlQueryExpression queryExpression) 
			: this(viewName, null, queryExpression) {
		}

		public CreateViewStatement(ObjectName viewName, IEnumerable&lt;string&gt; columnNames, SqlQueryExpression queryExpression) {
			if (viewName == null)
				throw new ArgumentNullException(&quot;viewName&quot;);
			if (queryExpression == null)
				throw new ArgumentNullException(&quot;queryExpression&quot;);

			ViewName = viewName;
			ColumnNames = columnNames;
			QueryExpression = queryExpression;
		}

		public ObjectName ViewName { get; private set; }

		public IEnumerable&lt;string&gt; ColumnNames { get; private set; }

		public SqlQueryExpression QueryExpression { get; private set; }

		public bool ReplaceIfExists { get; set; }

		public override StatementType StatementType {
			get { return StatementType.CreateView;}
		}

		protected override SqlPreparedStatement PrepareStatement(IQueryContext context) {
			var viewName = context.ResolveTableName(ViewName);

			var queryFrom = QueryExpressionFrom.Create(context, QueryExpression);
			var queryPlan = context.DatabaseContext.QueryPlanner().PlanQuery(context, QueryExpression, null);

			var colList = ColumnNames == null ? new string[0] : ColumnNames.ToArray();

			// Wrap the result around a SubsetNode to alias the columns in the
			// table correctly for this view.
			int sz = colList.Length;
			var originalNames = queryFrom.GetResolvedColumns();
			var newColumnNames = new ObjectName[originalNames.Length];

			if (sz &gt; 0) {
				if (sz != originalNames.Length)
					throw new InvalidOperationException(&quot;Column list is not the same size as the columns selected.&quot;);

				for (int i = 0; i &lt; sz; ++i) {
					var colName = colList[i];
					newColumnNames[i] = new ObjectName(viewName, colName);
				}
			} else {
				sz = originalNames.Length;
				for (int i = 0; i &lt; sz; ++i) {
					newColumnNames[i] = new ObjectName(viewName, originalNames[i].Name);
				}
			}

			// Check there are no repeat column names in the table.
			for (int i = 0; i &lt; sz; ++i) {
				var columnName = newColumnNames[i];
				for (int n = i + 1; n &lt; sz; ++n) {
					if (newColumnNames[n].Equals(columnName))
						throw new InvalidOperationException(String.Format(&quot;Duplicate column name &#39;{0}&#39; in view. A view may not contain duplicate column names.&quot;, columnName));
				}
			}

			// Wrap the plan around a SubsetNode plan
			queryPlan = new SubsetNode(queryPlan, originalNames, newColumnNames);

			// We have to execute the plan to get the TableInfo that represents the
			// result of the view execution.
			var table = queryPlan.Evaluate(context);
			var tableInfo = table.TableInfo.Alias(viewName);

			return new PreparedCreateView(tableInfo, queryPlan);
		}

		#region PreparedCreateView

		[Serializable]
		class PreparedCreateView : SqlPreparedStatement {
			public PreparedCreateView(TableInfo tableInfo, IQueryPlanNode queryPlan) {
				TableInfo = tableInfo;
				QueryPlan = queryPlan;
			}

			public TableInfo TableInfo { get; private set; }

			public IQueryPlanNode QueryPlan { get; private set; }

			public override ITable Evaluate(IQueryContext context) {
				throw new NotImplementedException();
			}
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[12,3,13,43,0],[14,3,14,4,0],[18,5,18,49,0],[20,5,20,56,0],[36,10,36,42,0],[40,4,40,54,0],[42,4,42,73,0],[43,4,43,101,0],[45,4,45,78,0],[49,4,49,28,0],[50,4,50,55,0],[51,4,51,62,0],[53,4,53,15,0],[54,5,54,36,0],[55,6,55,103,0],[57,10,57,20,0],[58,6,58,31,0],[59,6,59,60,0],[57,29,57,32,0],[57,21,57,27,0],[62,5,62,31,0],[63,10,63,20,0],[64,6,64,74,0],[63,29,63,32,0],[63,21,63,27,0],[69,9,69,19,0],[70,5,70,40,0],[71,10,71,24,0],[72,6,72,47,0],[73,7,73,157,0],[71,33,71,36,0],[71,25,71,31,0],[69,28,69,31,0],[69,20,69,26,0],[78,4,78,73,0],[82,4,82,44,0],[83,4,83,52,0],[85,4,85,56,0],[92,4,92,76,0],[93,5,93,27,0],[94,5,94,27,0],[95,4,95,5,0],[102,5,102,41,0],[16,3,16,119,1],[17,4,17,25,1],[19,4,19,32,1],[22,4,22,24,1],[23,4,23,30,1],[24,4,24,38,1],[25,3,25,4,1]]);
    </script>
  </body>
</html>