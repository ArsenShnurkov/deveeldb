<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb-nunit\deveel.data.routines\functionbuildtests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;

using Deveel.Data.DbSystem;
using Deveel.Data.Sql.Fluid;
using Deveel.Data.Security;
using Deveel.Data.Sql.Expressions;
using Deveel.Data.Sql.Objects;
using Deveel.Data.Types;

using Moq;

using NUnit.Framework;

namespace Deveel.Data.Routines {
	[TestFixture]
	public class FunctionBuildTests {
		private IQueryContext NewUserQueryContext(User user) {
			var sessionInfo = new SessionInfo(user);
			var sessionMock = new Mock&lt;IUserSession&gt;();
			sessionMock.Setup(x =&gt; x.SessionInfo)
				.Returns(sessionInfo);
			var queryContextMock = new Mock&lt;IQueryContext&gt;();
			queryContextMock.Setup(x =&gt; x.Session)
				.Returns(sessionMock.Object);
			return queryContextMock.Object;
		}

		[Test]
		public void ScalarWithNoArguments() {
			var factory1 = new Factory1();
			Assert.DoesNotThrow(factory1.Init);

			IFunction function = null;
			Assert.DoesNotThrow(() =&gt; function = factory1.ResolveFunction(&quot;user&quot;));
			Assert.IsNotNull(function);

			ExecuteResult result=null;
			var queryContext = NewUserQueryContext(User.System);
			Assert.DoesNotThrow(() =&gt; result = function.Execute(queryContext));
			Assert.IsNotNull(result);
			Assert.AreEqual(User.System.Name, result.ReturnValue.Value.ToString());
		}

		[Test]
		public void ScalarWithTwoArgument() {
			var factory2 = new Factory2();
			Assert.DoesNotThrow(factory2.Init);

			IFunction function = null;
			var args = new DataObject[] {DataObject.BigInt(2), DataObject.Number(new SqlNumber(54))};
			Assert.DoesNotThrow(() =&gt; function = factory2.ResolveFunction(&quot;add&quot;, args));
			Assert.IsNotNull(function);

			ExecuteResult result = null;
			Assert.DoesNotThrow(() =&gt; result = function.Execute(args));
			Assert.IsNotNull(result);

			Assert.IsInstanceOf&lt;SqlNumber&gt;(result.ReturnValue.Value);

			var value = ((SqlNumber) result.ReturnValue.Value).ToInt64();
			Assert.AreEqual(56, value);
		}

		#region Factory1

		class Factory1 : FunctionFactory {
			public override string SchemaName {
				get { return &quot;APP&quot;; }
			}

			protected override void OnInit() {
				New(&quot;user&quot;)
					.ReturnsType(PrimitiveTypes.String())
					.WhenExecute(context =&gt; context.Result(DataObject.String(context.QueryContext.User().Name)));
			}
		}

		#endregion

		#region Factory2

		class Factory2 : FunctionFactory {
			public override string SchemaName {
				get { return &quot;APP&quot;; }
			}

			protected override void OnInit() {
				New(&quot;add&quot;)
					.WithNumericParameter(&quot;a&quot;)
					.WithNumericParameter(&quot;b&quot;)
					.ReturnsNumeric()
					.WhenExecute(context =&gt; {
						var a = context.EvaluatedArguments[0];
						var b = context.EvaluatedArguments[1];
						return context.Result(a.Add(b));
					});
			}
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[18,4,18,44,1],[19,4,19,47,1],[20,4,21,27,1],[22,4,22,53,1],[23,4,24,34,1],[25,4,25,35,1],[30,4,30,34,1],[31,4,31,39,1],[33,4,33,30,1],[34,4,34,30,1],[34,73,34,75,1],[35,4,35,31,1],[37,4,37,30,1],[38,4,38,56,1],[39,4,39,30,1],[39,69,39,71,1],[40,4,40,29,1],[41,4,41,75,1],[42,3,42,4,1],[46,4,46,34,1],[47,4,47,39,1],[49,4,49,30,1],[50,4,50,93,1],[51,4,51,30,1],[51,78,51,80,1],[52,4,52,31,1],[54,4,54,32,1],[55,4,55,30,1],[55,61,55,63,1],[56,4,56,29,1],[58,4,58,61,1],[60,4,60,65,1],[61,4,61,31,1],[62,3,62,4,1],[68,11,68,24,1],[72,5,74,30,1],[74,97,74,99,1],[75,4,75,5,1],[74,30,74,97,1],[84,11,84,24,1],[88,5,93,7,1],[95,39,96,9,1],[97,4,97,5,1],[93,7,93,45,1],[94,7,94,45,1],[95,7,95,39,1],[34,30,34,73,1],[39,30,39,69,1],[51,30,51,78,1],[55,30,55,61,1]]);
    </script>
  </body>
</html>