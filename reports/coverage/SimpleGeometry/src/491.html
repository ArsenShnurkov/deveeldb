<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.sql\outertable.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections.Generic;
using System.Linq;

using Deveel.Data.Index;

namespace Deveel.Data.Sql {
	internal class OuterTable : VirtualTable {
		private readonly IList&lt;int&gt;[] outerRows;
		private int outerRowCount;

		private OuterTable(IEnumerable&lt;ITable&gt; tables, IList&lt;IEnumerable&lt;int&gt;&gt; rows)
			: base(tables, rows) {
			outerRows = new IList&lt;int&gt;[rows.Count];
		}

		public static OuterTable Create(ITable inputTable) {
			var baseTable = inputTable.GetRawTableInfo();
			var tables = baseTable.GetTables();
			var rows = baseTable.GetRows();

			return new OuterTable(tables, rows);
		}

		public override int RowCount {
			get { return base.RowCount + outerRowCount; }
		}

		public void MergeIn(ITable outsideTable) {
			var rawTableInfo = outsideTable.GetRawTableInfo();

			// Get the base information,
			var baseTables = ReferenceTables;
			IList&lt;int&gt;[] baseRows = ReferenceRows;

			// The tables and rows being merged in.
			var tables = rawTableInfo.GetTables();
			var rows = rawTableInfo.GetRows();
			// The number of rows being merged in.
			outerRowCount = rows[0].Count;

			for (int i = 0; i &lt; baseTables.Length; ++i) {
				var btable = baseTables[i];
				int index = -1;
				for (int n = 0; n &lt; tables.Length &amp;&amp; index == -1; ++n) {
					if (btable == tables[n]) {
						index = n;
					}
				}

				// If the table wasn&#39;t found, then set &#39;NULL&#39; to this base_table
				if (index == -1) {
					outerRows[i] = null;
				} else {
					List&lt;int&gt; list = new List&lt;int&gt;(outerRowCount);
					outerRows[i] = list;
					// Merge in the rows from the input table,
					IList&lt;int&gt; toMerge = rows[index];
					if (toMerge.Count != outerRowCount)
						throw new ApplicationException(&quot;Wrong size for rows being merged in.&quot;);

					list.AddRange(toMerge);
				}
			}
		}

		protected override ColumnIndex GetIndex(int column, int originalColumn, ITable table) {
			if (ColumnIndices[column] == null) {
				// EFFICIENCY: We implement this with a blind search...
				var index = new BlindSearchIndex(this, column);
				ColumnIndices[column] = index.GetSubset(this, column);
			}

			if (table == this)
				return ColumnIndices[column];

			return ColumnIndices[column].GetSubset(table, originalColumn);
		}

		public override DataObject GetValue(long rowNumber, int columnOffset) {
			int tableNum = ColumnTable[columnOffset];
			var parentTable = ReferenceTables[tableNum];

			if (rowNumber &gt;= outerRowCount) {
				rowNumber = ReferenceRows[tableNum][(int)rowNumber - outerRowCount];
				return parentTable.GetValue(rowNumber, ColumnFilter[columnOffset]);
			}

			if (outerRows[tableNum] == null)
				// Special case, handling outer entries (NULL)
				return new DataObject(TableInfo[columnOffset].ColumnType, null);

			rowNumber = outerRows[tableNum][(int)rowNumber];
			return parentTable.GetValue(rowNumber, ColumnFilter[columnOffset]);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,3,29,24,0],[30,4,30,43,0],[31,3,31,4,0],[34,4,34,49,0],[35,4,35,39,0],[36,4,36,35,0],[38,4,38,40,0],[42,10,42,47,0],[46,4,46,54,0],[49,4,49,37,0],[50,4,50,42,0],[53,4,53,42,0],[54,4,54,38,0],[56,4,56,34,0],[58,9,58,19,0],[59,5,59,32,0],[60,5,60,20,0],[61,10,61,20,0],[62,6,62,30,0],[63,7,63,17,0],[61,55,61,58,0],[61,21,61,53,0],[68,5,68,21,0],[69,6,69,26,0],[71,6,71,52,0],[72,6,72,26,0],[74,6,74,39,0],[75,6,75,41,0],[76,7,76,78,0],[78,6,78,29,0],[58,43,58,46,0],[58,20,58,41,0],[81,3,81,4,0],[84,4,84,38,0],[86,5,86,52,0],[87,5,87,59,0],[90,4,90,22,0],[91,5,91,34,0],[93,4,93,66,0],[97,4,97,45,0],[98,4,98,48,0],[100,4,100,35,0],[101,5,101,73,0],[102,5,102,72,0],[105,4,105,36,0],[107,5,107,69,0],[109,4,109,52,0],[110,4,110,71,0]]);
    </script>
  </body>
</html>