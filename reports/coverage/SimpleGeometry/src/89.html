<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.sql\indexsetinfo.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;

namespace Deveel.Data.Sql {
	[Serializable]
	public sealed class IndexSetInfo : IEnumerable&lt;IndexInfo&gt; {
		private readonly List&lt;IndexInfo&gt; indexes;

		private IndexSetInfo(ObjectName tableName, IEnumerable&lt;IndexInfo&gt; indexes, bool readOnly) {
			if (tableName == null)
				throw new ArgumentNullException(&quot;tableName&quot;);

			TableName = tableName;
			this.indexes = new List&lt;IndexInfo&gt;();

			if (indexes != null)
				this.indexes.AddRange(indexes);

			IsReadOnly = readOnly;
		}

		public IndexSetInfo(ObjectName tableName)
			: this(tableName, null, false) {
		}

		public ObjectName TableName { get; private set; }

		public bool IsReadOnly { get; private set; }

		public int IndexCount {
			get { return indexes.Count; }
		}

		private void AssertNotReadOnly() {
			if (IsReadOnly)
				throw new ArgumentException(&quot;The set is read-only.&quot;);
		}

		public void AddIndex(IndexInfo indexInfo) {
			AssertNotReadOnly();

			indexes.Add(indexInfo);
			indexInfo.Offset = indexes.Count;
		}

		public IndexInfo GetIndex(int offset) {
			return indexes.FirstOrDefault(x =&gt; x.Offset == offset);
		}

		public void RemoveIndexAt(int offset) {
			AssertNotReadOnly();

			indexes.RemoveAt(offset);
		}

		public IndexInfo FindNamedIndex(string indexName) {
			return FindNamedIndex(indexName, true);
		}

		public IndexInfo FindNamedIndex(string indexName, bool ignoreCase) {
			var compare = ignoreCase ? StringComparison.OrdinalIgnoreCase : StringComparison.Ordinal;
			return indexes.FirstOrDefault(x =&gt; x.IndexName.Equals(indexName, compare));
		}

		public int FindIndexOffset(string name) {
			return FindIndexOffset(name, true);
		}

		public int FindIndexOffset(string name, bool ignoreCase) {
			var compare = ignoreCase ? StringComparison.OrdinalIgnoreCase : StringComparison.Ordinal;
			return indexes.FindIndex(x =&gt; x.IndexName.Equals(name, compare));
		}

		public int FindIndexForColumns(string[] columnNames) {
			int sz = IndexCount;
			for (int i = 0; i &lt; sz; ++i) {
				string[] columns = indexes[i].ColumnNames;
				if (columns.Length == columnNames.Length) {
					bool passed = true;
					for (int n = 0; n &lt; columns.Length &amp;&amp; passed; ++n) {
						if (!columns[n].Equals(columnNames[n])) {
							passed = false;
						}
					}
					if (passed) {
						return i;
					}
				}
			}
			return -1;
		}


		public IndexSetInfo AsReadOnly() {
			return new IndexSetInfo(TableName, indexes.AsReadOnly(), true);
		}

		public IEnumerator&lt;IndexInfo&gt; GetEnumerator() {
			return indexes.GetEnumerator();
		}

		IEnumerator IEnumerable.GetEnumerator() {
			return GetEnumerator();
		}

		public void SerialiazeTo(Stream stream) {
			var schemaName = TableName.Parent;
			var catName = schemaName != null &amp;&amp; schemaName.Parent != null ? schemaName.Parent.Name : String.Empty;
			var schema = schemaName != null ? schemaName.Name : String.Empty;

			var writer = new BinaryWriter(stream, Encoding.Unicode);
			writer.Write(2);		// Version
			writer.Write(catName);
			writer.Write(schema);
			writer.Write(TableName.Name);

			int indexCount = indexes.Count;

			writer.Write(indexCount);

			for (int i = 0; i &lt; indexCount; i++) {
				var index = indexes[i];
				index.SerializeTo(stream);
			}
		}

		public static IndexSetInfo DeserializeFrom(Stream stream) {
			var reader = new BinaryReader(stream, Encoding.Unicode);

			var version = reader.ReadInt32();
			if (version != 2)
				throw new FormatException(&quot;Invalid version number of the Index-Set Info&quot;);

			var catName = reader.ReadString();
			var schemaName = reader.ReadString();
			var tableName = reader.ReadString();

			ObjectName objSchemaName;
			if (String.IsNullOrEmpty(catName)) {
				objSchemaName = new ObjectName(schemaName);
			} else {
				objSchemaName = new ObjectName(new ObjectName(catName), schemaName);
			}

			var objTableName = new ObjectName(objSchemaName, tableName);

			var indexCount = reader.ReadInt32();

			var indices = new List&lt;IndexInfo&gt;();
			for (int i = 0; i &lt; indexCount; i++) {
				var indexInfo = IndexInfo.DeserializeFrom(stream);
				indices.Add(indexInfo);
			}

			return new IndexSetInfo(objTableName, indices.AsReadOnly(), false);
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[31,5,31,50,0],[51,10,51,31,0],[56,5,56,58,0],[67,4,67,39,0],[67,57,67,59,0],[71,4,71,24,0],[73,4,73,29,0],[74,3,74,4,0],[77,4,77,43,0],[81,4,81,93,0],[82,4,82,39,0],[82,77,82,79,0],[86,4,86,39,0],[90,4,90,93,0],[91,4,91,34,0],[91,67,91,69,0],[95,4,95,24,0],[96,9,96,19,0],[97,5,97,47,0],[98,5,98,46,0],[99,6,99,25,0],[100,11,100,21,0],[101,7,101,46,0],[102,8,102,23,0],[100,52,100,55,0],[100,22,100,50,0],[105,6,105,17,0],[106,7,106,16,0],[96,28,96,31,0],[96,20,96,26,0],[110,4,110,14,0],[115,4,115,67,0],[119,4,119,35,0],[123,4,123,27,0],[152,5,152,79,0],[162,5,162,73,0],[67,39,67,57,0],[82,39,82,77,0],[91,34,91,67,0],[29,3,29,92,1],[30,4,30,26,1],[33,4,33,26,1],[34,4,34,41,1],[36,4,36,24,1],[37,5,37,36,1],[39,4,39,26,1],[40,3,40,4,1],[42,3,43,34,1],[44,3,44,4,1],[55,4,55,19,1],[57,3,57,4,1],[60,4,60,24,1],[62,4,62,27,1],[63,4,63,37,1],[64,3,64,4,1],[127,4,127,38,1],[128,4,128,106,1],[129,4,129,69,1],[131,4,131,60,1],[132,4,132,20,1],[133,4,133,26,1],[134,4,134,25,1],[135,4,135,33,1],[137,4,137,35,1],[139,4,139,29,1],[141,9,141,19,1],[142,5,142,28,1],[143,5,143,31,1],[141,36,141,39,1],[141,20,141,34,1],[145,3,145,4,1],[148,4,148,60,1],[150,4,150,37,1],[151,4,151,21,1],[154,4,154,38,1],[155,4,155,41,1],[156,4,156,40,1],[159,4,159,38,1],[160,5,160,48,1],[165,4,165,64,1],[167,4,167,40,1],[169,4,169,40,1],[170,9,170,19,1],[171,5,171,55,1],[172,5,172,28,1],[170,36,170,39,1],[170,20,170,34,1],[175,4,175,71,1]]);
    </script>
  </body>
</html>