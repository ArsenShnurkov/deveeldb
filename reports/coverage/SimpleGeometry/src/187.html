<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.sql.query\fromtablesubquerysource.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Linq;

using Deveel.Data.Sql.Expressions;

namespace Deveel.Data.Sql.Query {
	/// &lt;summary&gt;
	/// An implementation of &lt;see cref=&quot;IFromTableSource&quot;/&gt; that wraps around a 
	/// &lt;see cref=&quot;SqlQueryExpression&quot;/&gt; as a sub-query source.
	/// &lt;/summary&gt;
	public class FromTableSubQuerySource : IFromTableSource {
		private ObjectName[] columnNames;

		internal FromTableSubQuerySource(bool caseInsensitive, string uniqueKey, SqlQueryExpression queryExpression,
			QueryExpressionFrom fromSet, ObjectName alias) {
			UniqueName = uniqueKey;
			QueryExpression = queryExpression;
			QueryFrom = fromSet;
			AliasName = alias;
			IgnoreCase = caseInsensitive;
		}

		public bool MatchesReference(string catalog, string schema, string table) {
			if (schema == null &amp;&amp; table == null)
				return true;

			if (AliasName != null) {
				string ts = AliasName.Parent.Name;
				string tt = AliasName.Name;
				if (schema == null)
					return StringCompare(tt, table);
				if (StringCompare(tt, table) &amp;&amp; StringCompare(ts, schema))
					return true;
			}

			// No way to determine if there is a match
			return false;
		}

		public SqlQueryExpression QueryExpression { get; private set; }

		public QueryExpressionFrom QueryFrom { get; private set; }

		public ObjectName AliasName { get; private set; }

		public bool IgnoreCase { get; private set; }

		public string UniqueName { get; private set; }

		public ObjectName[] ColumnNames {
			get {
				EnsureColumnNames();
				return columnNames;
			}
		}

		/// &lt;summary&gt;
		/// Makes sure the &lt;see cref=&quot;columnNames&quot;/&gt; list is created correctly.
		/// &lt;/summary&gt;
		private void EnsureColumnNames() {
			if (columnNames == null) {
				columnNames = QueryFrom.GetResolvedColumns();

				// Are the variables aliased to a table name?
				if (AliasName != null) {
					for (int i = 0; i &lt; columnNames.Length; ++i) {
						columnNames[i] = new ObjectName(AliasName, columnNames[i].Name);
					}
				}
			}
		}

		private bool StringCompare(string str1, string str2) {
			var comparison = IgnoreCase ? StringComparison.OrdinalIgnoreCase : StringComparison.Ordinal;
			return String.Equals(str1, str2, comparison);
		}

		private bool Matches(ObjectName name, string catalog, string schema, string table, string column) {
			var tableName = name.Parent;
			var schemaName = tableName == null ? null : tableName.Parent;
			var catalogName = schemaName == null ? null : schemaName.Parent;
			var columnName = name.Name;

			if (column == null)
				return true;
			if (!StringCompare(columnName, column))
				return false;

			if (table == null)
				return true;
			if (tableName == null)
				return false;

			string tname = tableName.Name;
			if (tname != null &amp;&amp; !StringCompare(tname, table))
				return false;

			if (schema == null)
				return true;

			string sname = schemaName != null ? schemaName.Name : null;
			if (sname != null &amp;&amp; !StringCompare(sname, schema))
				return false;

			string cname = catalogName != null ? catalogName.Name : null;
			if (cname != null &amp;&amp; !StringCompare(cname, catalog))
				return false;

			return true;
		}

		public int ResolveColumnCount(string catalog, string schema, string table, string column) {
			EnsureColumnNames();

			if (String.IsNullOrEmpty(catalog) &amp;&amp; 
				String.IsNullOrEmpty(schema) &amp;&amp; 
				String.IsNullOrEmpty(table) &amp;&amp; 
				String.IsNullOrEmpty(column))
				return columnNames.Length;

			return columnNames.Count(v =&gt; Matches(v, catalog, schema, table, column));

		}

		public ObjectName ResolveColumn(string catalog, string schema, string table, string column) {
			EnsureColumnNames();

			var result = columnNames.FirstOrDefault(v =&gt; Matches(v, catalog, schema, table, column));
			if (result == null)
				throw new ApplicationException(&quot;Couldn&#39;t resolve to a column.&quot;);

			return result;
		}
	}
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[30,3,31,50,0],[32,4,32,27,0],[33,4,33,38,0],[34,4,34,24,0],[35,4,35,22,0],[36,4,36,33,0],[37,3,37,4,0],[40,4,40,40,0],[41,5,41,17,0],[43,4,43,26,0],[44,5,44,39,0],[45,5,45,32,0],[46,5,46,24,0],[47,6,47,38,0],[48,5,48,63,0],[49,6,49,18,0],[53,4,53,17,0],[68,5,68,25,0],[69,5,69,24,0],[77,4,77,28,0],[78,5,78,50,0],[81,5,81,27,0],[82,11,82,21,0],[83,7,83,71,0],[82,46,82,49,0],[82,22,82,44,0],[87,3,87,4,0],[90,4,90,96,0],[91,4,91,49,0],[95,4,95,32,0],[96,4,96,65,0],[97,4,97,68,0],[98,4,98,31,0],[100,4,100,23,0],[101,5,101,17,0],[102,4,102,43,0],[103,5,103,18,0],[105,4,105,22,0],[106,5,106,17,0],[107,4,107,26,0],[108,5,108,18,0],[110,4,110,34,0],[111,4,111,54,0],[112,5,112,18,0],[114,4,114,23,0],[115,5,115,17,0],[117,4,117,63,0],[118,4,118,55,0],[119,5,119,18,0],[121,4,121,65,0],[122,4,122,56,0],[123,5,123,18,0],[125,4,125,16,0],[129,4,129,24,0],[131,4,134,34,0],[135,5,135,31,0],[137,4,137,34,0],[137,76,137,78,0],[142,4,142,24,0],[144,4,144,49,0],[144,91,144,93,0],[145,4,145,23,0],[146,5,146,69,0],[148,4,148,18,0],[137,34,137,76,0],[144,49,144,91,0]]);
    </script>
  </body>
</html>