<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\deveel\deveeldb\src\deveeldb\deveel.data.sql.compile\statementbuilder.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// 
//  Copyright 2010-2015 Deveel
// 
//    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
//    you may not use this file except in compliance with the License.
//    You may obtain a copy of the License at
// 
//        http://www.apache.org/licenses/LICENSE-2.0
// 
//    Unless required by applicable law or agreed to in writing, software
//    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
//    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//    See the License for the specific language governing permissions and
//    limitations under the License.
//

using System;
using System.Collections.Generic;
using System.Linq;

using Deveel.Data.Sql.Expressions;
using Deveel.Data.Sql.Statements;
using Deveel.Data.Types;

namespace Deveel.Data.Sql.Compile {
	public sealed class StatementBuilder : SqlNodeVisitor {
		private readonly IUserTypeResolver typeResolver;
		private readonly List&lt;SqlStatement&gt; statements;

		public StatementBuilder() 
			: this(null) {
		}

		public StatementBuilder(IUserTypeResolver typeResolver) {
			this.typeResolver = typeResolver;
			statements = new List&lt;SqlStatement&gt;();
		}

		private SqlExpression Expression(IExpressionNode node) {
			var visitor = new ExpressionBuilder();
			return visitor.Build(node);
		}

		public override void Visit(ISqlNode node) {
			if (node is CreateTableNode)
				VisitCreateTable((CreateTableNode) node);
			if (node is CreateViewNode)
				VisitCreateView((CreateViewNode) node);
			if (node is CreateTriggerNode)
				VisitCreateTrigger((CreateTriggerNode) node);

			if (node is SelectStatementNode)
				VisitSelect((SelectStatementNode) node);

			if (node is SequenceOfStatementsNode)
				VisitSequenceOfStatements((SequenceOfStatementsNode) node);
		}

		private void VisitSequenceOfStatements(SequenceOfStatementsNode node) {
			foreach (var statementNode in node.Statements) {
				Visit(statementNode);
			}
		}

		public override void VisitSelect(SelectStatementNode node) {
			var queryExpression = (SqlQueryExpression)Expression(node.QueryExpression);
			var statement = new SqlSelectStatement(queryExpression);
			statements.Add(statement);
		}

		public override void VisitCreateTrigger(CreateTriggerNode node) {
			
		}

		public override void VisitCreateView(CreateViewNode node) {
			var queryExpression = (SqlQueryExpression)Expression(node.QueryExpression);
			var statement = new CreateViewStatement(node.ViewName.Name, node.ColumnNames, queryExpression);
			statements.Add(statement);
		}

		public override void VisitCreateTable(CreateTableNode node) {
			CreateTable.Build(typeResolver, node, statements);
		}

		public IEnumerable&lt;SqlStatement&gt; Build(ISqlNode rootNode, SqlQuery query) {
			Visit(rootNode);
			return statements.AsReadOnly();
		}

		public IEnumerable&lt;SqlStatement&gt; Build(ISqlNode rootNode, string query) {
			return Build(rootNode, new SqlQuery(query));
		}

		#region CreateTable

		static class CreateTable {
			public static void Build(IUserTypeResolver typeResolver, CreateTableNode node, ICollection&lt;SqlStatement&gt; statements) {
				string idColumn = null;

				var dataTypeBuilder = new DataTypeBuilder();

				var tableName = node.TableName;
				var constraints = new List&lt;ConstraintInfo&gt;();
				var columns = new List&lt;SqlTableColumn&gt;();

				var expBuilder = new ExpressionBuilder();

				foreach (var column in node.Columns) {
					var dataType = dataTypeBuilder.Build(typeResolver, column.DataType);

					var columnInfo = new SqlTableColumn(column.ColumnName.Text, dataType);

					if (column.Default != null)
						columnInfo.DefaultExpression = expBuilder.Build(column.Default);

					if (column.IsIdentity) {
						if (!String.IsNullOrEmpty(idColumn))
							throw new InvalidOperationException(String.Format(&quot;Table {0} defines already {1} as identity column.&quot;,
								node.TableName, idColumn));

						if (column.Default != null)
							throw new InvalidOperationException(String.Format(&quot;The identity column {0} cannot have a DEFAULT constraint.&quot;,
								idColumn));

						idColumn = column.ColumnName.Text;

						columnInfo.DefaultExpression = SqlExpression.FunctionCall(&quot;UNIQUEKEY&quot;,
							new[] {SqlExpression.Constant(node.TableName.Name.FullName)});
					}

					foreach (var constraint in column.Constraints) {
						if (String.Equals(ConstraintTypeNames.Check, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
							var exp = expBuilder.Build(constraint.CheckExpression);
							constraints.Add(ConstraintInfo.Check(tableName.Name, exp, column.ColumnName.Text));
						} else if (String.Equals(ConstraintTypeNames.ForeignKey, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
							var fTable = constraint.ReferencedTable.Name;
							var fColumn = constraint.ReferencedColumn.Text;
							var fkey = ConstraintInfo.ForeignKey(tableName.Name, column.ColumnName.Text, fTable, fColumn);
							if (!String.IsNullOrEmpty(constraint.OnDeleteAction))
								fkey.OnDelete = GetForeignKeyAction(constraint.OnDeleteAction);
							if (!String.IsNullOrEmpty(constraint.OnUpdateAction))
								fkey.OnUpdate = GetForeignKeyAction(constraint.OnUpdateAction);

							constraints.Add(fkey);
						} else if (String.Equals(ConstraintTypeNames.PrimaryKey, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
							constraints.Add(ConstraintInfo.PrimaryKey(tableName.Name, column.ColumnName.Text));
						} else if (String.Equals(ConstraintTypeNames.UniqueKey, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
							constraints.Add(ConstraintInfo.Unique(tableName.Name, column.ColumnName.Text));
						} else if (String.Equals(ConstraintTypeNames.NotNull, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
							columnInfo.IsNotNull = true;
						} else if (String.Equals(ConstraintTypeNames.Null, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
							columnInfo.IsNotNull = false;
						}
					}

					columns.Add(columnInfo);
				}

				foreach (var constraint in node.Constraints) {
					if (String.Equals(ConstraintTypeNames.Check, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
						var exp = expBuilder.Build(constraint.CheckExpression);
						constraints.Add(ConstraintInfo.Check(constraint.ConstraintName, tableName.Name, exp, constraint.Columns.ToArray()));
					} else if (String.Equals(ConstraintTypeNames.PrimaryKey, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
						constraints.Add(ConstraintInfo.PrimaryKey(constraint.ConstraintName, tableName.Name, constraint.Columns.ToArray()));
					} else if (String.Equals(ConstraintTypeNames.UniqueKey, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
						constraints.Add(ConstraintInfo.Unique(constraint.ConstraintName, tableName.Name, constraint.Columns.ToArray()));
					} else if (String.Equals(ConstraintTypeNames.ForeignKey, constraint.ConstraintType, StringComparison.OrdinalIgnoreCase)) {
						var fTable = constraint.ReferencedTableName.Name;
						var fColumns = constraint.ReferencedColumns;
						var fkey = ConstraintInfo.ForeignKey(constraint.ConstraintName, tableName.Name, constraint.Columns.ToArray(), fTable,
							fColumns.ToArray());
						if (!String.IsNullOrEmpty(constraint.OnDeleteAction))
							fkey.OnDelete = GetForeignKeyAction(constraint.OnDeleteAction);
						if (!String.IsNullOrEmpty(constraint.OnUpdateAction))
							fkey.OnUpdate = GetForeignKeyAction(constraint.OnUpdateAction);

						constraints.Add(fkey);
					}
				}

				//TODO: Optimization: merge same constraints

				statements.Add(MakeCreateTable(tableName.Name, columns, node.IfNotExists, node.Temporary));

				foreach (var constraint in constraints) {
					statements.Add(MakeAlterTableAddConstraint(tableName.Name, constraint));
				}
			}

			private static ForeignKeyAction GetForeignKeyAction(string actionName) {
				if (String.Equals(&quot;NO ACTION&quot;, actionName, StringComparison.OrdinalIgnoreCase) ||
					String.Equals(&quot;NOACTION&quot;, actionName, StringComparison.OrdinalIgnoreCase))
					return ForeignKeyAction.NoAction;
				if (String.Equals(&quot;CASCADE&quot;, actionName, StringComparison.OrdinalIgnoreCase))
					return ForeignKeyAction.Cascade;
				if (String.Equals(&quot;SET DEFAULT&quot;, actionName, StringComparison.OrdinalIgnoreCase) ||
					String.Equals(&quot;SETDEFAULT&quot;, actionName, StringComparison.OrdinalIgnoreCase))
					return ForeignKeyAction.SetDefault;
				if (String.Equals(&quot;SET NULL&quot;, actionName, StringComparison.OrdinalIgnoreCase) ||
					String.Equals(&quot;SETNULL&quot;, actionName, StringComparison.OrdinalIgnoreCase))
					return ForeignKeyAction.SetNull;

				throw new NotSupportedException();
			}

			private static SqlStatement MakeAlterTableAddConstraint(ObjectName tableName, ConstraintInfo constraint) {
				var action = new AddConstraintAction(constraint);

				return new SqlAlterTableStatement(tableName,new List&lt;IAlterTableAction&gt;{action});
			}

			private static SqlStatement MakeCreateTable(ObjectName tableName, IEnumerable&lt;SqlTableColumn&gt; columns, bool ifNotExists, bool temporary) {
				var tree = new CreateTableStatement(tableName, columns.ToList());
				tree.IfNotExists = ifNotExists;
				tree.Temporary = temporary;
				return tree;
			}
		}

		#endregion
	}
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[50,5,50,50,0],[73,3,73,4,0],[118,8,119,36,0],[122,8,123,20,0],[133,8,133,63,0],[134,8,134,91,0],[136,8,136,53,0],[137,8,137,55,0],[138,8,138,102,0],[139,8,139,61,0],[140,9,140,72,0],[141,8,141,61,0],[142,9,142,72,0],[144,8,144,30,0],[148,8,148,87,0],[151,14,151,121,0],[152,8,152,37,0],[161,7,161,62,0],[162,7,162,123,0],[164,7,164,123,0],[167,13,167,126,0],[168,7,168,56,0],[169,7,169,51,0],[170,7,171,28,0],[172,7,172,60,0],[173,8,173,71,0],[174,7,174,60,0],[175,8,175,71,0],[177,7,177,29,0],[191,5,192,80,0],[193,6,193,39,0],[194,5,194,82,0],[195,6,195,38,0],[196,5,197,82,0],[198,6,198,41,0],[199,5,200,79,0],[201,6,201,38,0],[203,5,203,39,0],[30,3,31,16,1],[32,3,32,4,1],[34,3,34,58,1],[35,4,35,37,1],[36,4,36,42,1],[37,3,37,4,1],[40,4,40,42,1],[41,4,41,31,1],[45,4,45,32,1],[46,5,46,46,1],[47,4,47,31,1],[48,5,48,44,1],[49,4,49,34,1],[52,4,52,36,1],[53,5,53,45,1],[55,4,55,41,1],[56,5,56,64,1],[57,3,57,4,1],[60,34,60,49,1],[60,13,60,30,1],[61,5,61,26,1],[60,31,60,33,1],[63,3,63,4,1],[66,4,66,79,1],[67,4,67,60,1],[68,4,68,30,1],[69,3,69,4,1],[76,4,76,79,1],[77,4,77,99,1],[78,4,78,30,1],[79,3,79,4,1],[82,4,82,54,1],[83,3,83,4,1],[86,4,86,20,1],[87,4,87,35,1],[91,4,91,48,1],[98,5,98,28,1],[100,5,100,49,1],[102,5,102,36,1],[103,5,103,50,1],[104,5,104,46,1],[106,5,106,46,1],[108,28,108,40,1],[108,14,108,24,1],[109,6,109,74,1],[111,6,111,76,1],[113,6,113,33,1],[114,7,114,71,1],[116,6,116,28,1],[117,7,117,43,1],[121,7,121,34,1],[125,7,125,41,1],[127,7,128,70,1],[131,33,131,51,1],[131,15,131,29,1],[132,7,132,115,1],[135,14,135,127,1],[145,14,145,127,1],[146,8,146,91,1],[147,14,147,126,1],[149,14,149,124,1],[150,8,150,36,1],[131,30,131,32,1],[156,6,156,30,1],[108,25,108,27,1],[159,32,159,48,1],[159,14,159,28,1],[160,6,160,114,1],[163,13,163,126,1],[165,13,165,125,1],[166,7,166,119,1],[159,29,159,31,1],[183,5,183,96,1],[185,32,185,43,1],[185,14,185,28,1],[186,6,186,78,1],[185,29,185,31,1],[188,4,188,5,1],[207,5,207,54,1],[209,5,209,86,1],[213,5,213,70,1],[214,5,214,36,1],[215,5,215,32,1],[216,5,216,17,1]]);
    </script>
  </body>
</html>